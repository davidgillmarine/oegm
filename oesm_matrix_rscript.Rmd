---
title: "OEGM script"
author: "David A. Gill & Dana I. Grieco"
date: "3/15/2024"
output: html_document
---
# Note for Others:
If you use this script, please acknowledge David A. Gill, Samantha H. Cheng, and Dana I. Grieco in your paper. Thank you!

#Before Beginning: Update R and R Studio

##Updating R Studio
Go to 'Help' > 'Check for Updates' to install newest version

## Updating R
First, check your current version of R, and see if it is the same or behind the current version listed at https://cran.r-project.org/bin/windows/base/
```{r echo=FALSE, warning=FALSE, include=FALSE, eval=FALSE}
sessionInfo()
```
If you do need to update r, install the installr package if you don’t have it.
```{r echo=FALSE, warning=FALSE, include=FALSE, eval=FALSE}
# installing/loading the package:
# if(!require(installr)) {
#   install.packages("installr"); 
#   require(installr)
# } #load / install+load installr
```
Then call updateR() function to call update. This will start the updating process of your R installation. It will check for newer versions, and if one is available, will guide you through the decisions you’d need to make.
  *Note: R studio might direct you to use updateR() in R Gui. If it does, you will need to load installr 'library(installr)' IN R Gui before updating.*
```{r echo=FALSE, warning=FALSE, eval=FALSE, include=FALSE}
# using the package:
 # updateR()
```
**After you update R, make sure to DELETE the old version of R from your computer!** Otherwise, R Studio will just stay attached to the old version of R.

# Install Pacman IF you've updated R
[Pacman](http://trinker.github.io/pacman/vignettes/Introduction_to_pacman.html) is a package management tool. The most important part of this package is that it will install and load packages (install.packages() and library()) by only using p_load(). It can also load and install github packages using p_load_git(). It also can update packages (update.packages) using p_update OR using the update option. The biggest draw is that Pacman can do this for ALL packages at once! :)
 
```{r installing load pacman, echo=FALSE, include=FALSE, eval=FALSE}
# install.packages("pacman")
# use this package to load other packages, re-download if updated R. don't need to load it itself - use it with pacman::function to do this
```
### A note for installation:
With installing and updating packages, remember that you can also use Tools > Check for Package updates and the packages tab (in the bottom right console window) > updates to make sure all of the packages are up to date and update any packages that need updating!

# Setup
Loads libraries, reads in data, cleans datasets
```{r eval=T}
#set working directory to the correct folders on your machine
workdir <- "R:/Gill/research/oegm/"
inputdir <- paste0(workdir,"tables/raw/")
mapdir <-  paste0(workdir,"spatial/raw/")
plotdir <- paste0(workdir,"output/plots/")
tabledir <- paste0(workdir,"output/tables/")

library(pacman) # I shouldn't need to do this, but pacman NEVER works for me with the :: below, so I need to add this
pacman::p_load(rmarkdown,broom,rio,treemap,treemapify,gtools,cowplot,rnaturalearth,rnaturalearthdata,devtools,sf,rnaturalearthhires,tidyverse,dplyr)
  #WARNING: package ‘rgeos’ is not available for this version of R - take out? I think this is the OLD world map!
  # MAKE SURE rnaturalearthhires loads - installed via github -  devtools::install_github("ropensci/rnaturalearthhires")

today.date <- gsub("-","",Sys.Date())
```

## Triple-Check that Packages are Loaded
```{r double-check installation, echo=FALSE, warning=FALSE, include=FALSE, eval=FALSE}
# check to make sure packages don't need updates
old.packages()
  # this will list all packages where update is available

#update all available packages, without prompts for permission/clarification
update.packages(ask=FALSE)
```
#if old packages aren't updating, then go to Session > Restart R, and then run this chunk before going back to the top of the script
  otherwise, they can do the "package in use, won't update" situation

# Organize data

```{r eval=T}
#read in data, skip first 2 rows
all.data<-import(paste0(inputdir,"20240315_All_Papers.xlsx"), which="FULL Data Extraction Sheet",skip =2, .name_repair = "universal") %>% 
  mutate(Date=as.character(Date))

country <- import(paste0(inputdir,"allcountries.csv"))
  # OLD country datafile, but will still be useful!

# Count total papers in Full Text Screening
length(unique(all.data$Article.ID)) # should be 779 (as of 3/15/24)

# Count Rejected Papers
Reject_data <- all.data %>%  
  filter(Full.text.screening.=="Reject") %>% 
  rename(Why_rejected=If.rejected..why.,PICO_details=Further.PICO.Details, aid=Article.ID,study.ctry=Country.ies..of.study)
length(unique(Reject_data$aid)) #= how many rejected papers # should be 608 (as of 3/15/24)

# Select accepted papers, rename variables==
data_all <- all.data %>%  
  filter(Full.text.screening.=="Accept" & !is.na(Intervention.category) & !is.na(Outcome.category)) %>% 
  rename(Int_cat=Intervention.category,Outcome_cat=Outcome.category, aid=Article.ID, study.ctry=Country.ies..of.study)
length(unique(data_all$aid)) # = how many accepted & completely screened papers # should be 171 (as of 3/15/24)

# read in full intervention lists
int_list<-import(paste0(inputdir,"intervention abbreviations.csv"))
out_list<-import(paste0(inputdir,"outcome abbreviations 2.csv")) #adjusted for '24 name changes

#NOTE: the DROP DOWN LISTS here, which collect ALL of the dropdowns, are taken from the ALL PAPERS Master Sheet!
drop.down.lists<-import(paste0(inputdir,"20240315_All_Papers.xlsx"), which="Dropdowns", skip =1, .name_repair = "universal")

int_sub_list <-  drop.down.lists %>% 
  select(Intervention.subcategory) %>% 
  na.omit() %>% 
  rename(int_sub=Intervention.subcategory)
out_sub_list <-  drop.down.lists %>% 
  select(Outcome.subcategory) %>% 
  na.omit() %>% 
  rename(out_sub=Outcome.subcategory) 
num.studies <- length(unique(data_all$aid)) #should again be 171
```

# CLEAN UP Rejected at Full Text Paper Data

```{r eval=T}
# If Rejected, Why?!
unique(Reject_data$Why_rejected)  # Separate ;, then count each group

## Update Fields to get stats for each category (without semicolon (;) confusion)
Reject_data <- Reject_data %>% 
mutate(OtherReason=ifelse(grepl("Other Reason",Why_rejected,ignore.case = T),1,0), # note: ignores case, so the lowercase is fine!
       Doesnt_fit_PICO=ifelse(grepl("Doesn't fit PICO/Inclusion Criteria",Why_rejected,ignore.case = T),1,0), 
       Could_not_locate=ifelse(grepl("Could not locate",Why_rejected,ignore.case = T),1,0), 
       Not_accessible=ifelse(grepl("Not accessible",Why_rejected,ignore.case = T),1,0), 
       Review_or_MA=ifelse(grepl("Reviews/Meta-Analysis",Why_rejected,ignore.case = T),1,0), 
       Duplicate=ifelse(grepl("Duplicate",Why_rejected,ignore.case = T),1,0), 
       Non_English=ifelse(grepl("Non-English Language",Why_rejected,ignore.case = T),1,0),)

## check Why Rejected Coding
unique(Reject_data$Why_rejected[Reject_data$OtherReason==1])
unique(Reject_data$Why_rejected[Reject_data$Doesnt_fit_PICO==1])
unique(Reject_data$Why_rejected[Reject_data$Could_not_locate==1])
unique(Reject_data$Why_rejected[Reject_data$Not_accessible==1])
unique(Reject_data$Why_rejected[Reject_data$Review_or_MA==1])
unique(Reject_data$Why_rejected[Reject_data$Duplicate==1])
unique(Reject_data$Why_rejected[Reject_data$Non_English==1])
  # Correct? yes

Why_rejected.test <- Reject_data %>% 
  filter(OtherReason==0 & Doesnt_fit_PICO==0 & Could_not_locate==0 & Not_accessible==0 & Review_or_MA==0 & Duplicate==0 & Non_English==0) %>% 
  select(Why_rejected)
unique(Why_rejected.test$Why_rejected) # should just be 0 - no other categories
  # Correct? yes

# Further PICO Details (I.E intervention, outcome, etc)
unique(Reject_data$PICO_details)  # Separate ;, then count each group

## Update Fields to get stats for each category (without semicolon (;) confusion)
Reject_data <- Reject_data %>% 
mutate(Population=ifelse(grepl("Population",PICO_details,ignore.case = T),1,0), # note: ignores case, so the lowercase is fine!
       Intervention=ifelse(grepl("Intervention",PICO_details,ignore.case = T),1,0), 
       Outcome=ifelse(grepl("Outcome",PICO_details,ignore.case = T),1,0), 
       Theoretical_Modeled_Study=ifelse(grepl("Theoretical/Modeled Study Design",PICO_details,ignore.case = T),1,0), 
       Not_Peer_Reviewed=ifelse(grepl("Not Peer Reviewed",PICO_details,ignore.case = T),1,0),
       N_A=ifelse(grepl("NA",PICO_details,ignore.case = T),1,0),) 
          ## NA Studies - AKA The Paper DID Fit PICO, but something else had been wrong with it in the EARLIER column... don't worry about these!

## check Why Rejected Coding
unique(Reject_data$PICO_details[Reject_data$Population==1])
unique(Reject_data$PICO_details[Reject_data$Intervention==1])
unique(Reject_data$PICO_details[Reject_data$Outcome==1])
unique(Reject_data$PICO_details[Reject_data$Theoretical_Modeled_Study==1])
unique(Reject_data$PICO_details[Reject_data$Review_or_MA==1])
unique(Reject_data$PICO_details[Reject_data$Not_Peer_Reviewed==1])
unique(Reject_data$PICO_details[Reject_data$N_A==1])
  # Correct? yes

PICO_details.test <- Reject_data %>% 
  filter(Population==0 & Intervention==0 & Outcome==0 & Theoretical_Modeled_Study==0 & Review_or_MA==0 & Not_Peer_Reviewed==0 & N_A==0) %>% 
  select(PICO_details)
unique(PICO_details.test$PICO_details) # should just be 0 - no other categories
  # Correct? yes
```

# Clean Up Accepted Paper Data

```{r eval=T}
#--- Clean up data ----

# Re-codes intervention and outcomes fields to the correct version 
# interventions
for (i in 1:nrow(int_list)){
  num.val=paste0("^",i,"\\. *") # starts with this number
  data_all <- data_all %>% 
    mutate(Int_cat=ifelse(grepl(num.val,Int_cat),grep(num.val,int_list$Int_cat_orig,value = T),Int_cat))
}
# sub-interventions
for (i in 1:nrow(int_sub_list)){
  num.val=paste0("^",gsub("\\.(.*)","",int_sub_list$int_sub[i]))  # starts with this number
  data_all <- data_all %>% 
    mutate(Intervention.subcategory=ifelse(grepl(num.val,Intervention.subcategory),
                                           grep(num.val,int_sub_list$int_sub,value = T),Intervention.subcategory))
}
# Outcomes
for (i in 1:nrow(out_list)){
  num.val=paste0("^",i)
  data_all <- data_all %>% 
    mutate(Outcome_cat=ifelse(grepl(num.val,Outcome_cat),grep(num.val,out_list$Outcome_cat_orig,value = T),Outcome_cat))
}
# Sub-outcomes
for (i in 1:nrow(out_sub_list)){
  num.val=paste0("^",gsub("\\.(.*)","",out_sub_list$out_sub[i]))  # starts with this number
  data_all <- data_all %>% 
    mutate(Outcome.subcategory=ifelse(grepl(num.val,Outcome.subcategory),
                                           grep(num.val,out_sub_list$out_sub,value = T),Outcome.subcategory))
}
```

# Habitat Field Data - Creating Columns for Each Habitat

```{r eval=T}  
# Add habitat fields
unique(data_all$Habitat.type) 
data_all <- data_all %>% 
mutate(coral=ifelse(grepl("Coral",Habitat.type,ignore.case = T),1,0),
       seagrass=ifelse(grepl("Seagrass",Habitat.type,ignore.case = T),1,0), 
       # note: ignores case, so the lowercase "seagrass" is fine!
       mangrove=ifelse(grepl("Mangrove",Habitat.type,ignore.case = T),1,0),)

# check habitat coding
unique(data_all$Habitat.type[data_all$coral==1])
unique(data_all$Habitat.type[data_all$seagrass==1])
unique(data_all$Habitat.type[data_all$mangrove==1])
  # Correct - all sorted

habitat.test <- data_all %>% 
  filter(coral==0 & mangrove==0 & seagrass==0) %>% 
  select(Habitat.type)
unique(habitat.test$Habitat.type) # should just be 0 - no other categories (we took out the "Other" category)       
```

# MORE Data Cleaning, For Categories missed OR that need fixing in some way
- Entry issues: Year Change (1 paper), Country entry Change (aid 375), 
- Name Change for countries, to match country data :)
- data_all becomes data_all2

##AID 375 - Issue with Bad Drop Down / Wrongly coded countries - this is my key!
- 1. Arabian Sea (ARABS): Yemen; 
- 2. Western Australia (AUSW: Scott Reef, Cocos–Keeling Islands, Christmas Island): Indian Ocean Territories; Australia; 
- 3. Didn't make it, not enough data... was Bangladesh
- 4. Central Indian Ocean Islands (CIOI: Chagos, Lakshadweep (India), Maldives, Seychelles): Chagos - British Indian Ocean Territory; Maldives; Seychelles;
- 5. East Africa (EAFR: Kenya, Tanzania): Kenya; United Republic of Tanzania; Mozambique; 
- 6. Eastern Indian Ocean (EIO: Andaman–Nicobar (India), Western Indonesia (Sumatra), Kambodia, Myanmar/Burma, Thailand): India; Indonesia; Cambodia; Myanmar; Thailand; 
- 7. Arabian/Persian Gulf (GULF): Oman; United Arab Emirates; Qatar; Bahrain; Kuwait; Iraq; Iran; 
- 8. Southern India and Sri Lanka (IND–SRI): Sri Lanka; 
- 9. Mozambique and South Africa (MOZ–SAF): South Africa; 
- 10. Red Sea–Gulf of Aden (RS–GA): Djibouti; Eritrea; Sudan; Egypt; Isreal; Jordan; Saudi Arabia; 
- 11. South Western Indian Ocean Islands (SWIOI: Comoros, Madagascar, Mauritius, Mayotte, Reunion, Rodrigues (Mauritius)): Comoros; Madagascar; Mauritius; France (Mayotte); France (Reunion); 

```{r eval=T}
#AID 375 - Issue with Bad Drop Down / Wrongly coded countries - must mutate
    # Mutate AID 375, where the countries were improperly entered!
    # Country names matched with study list taken from study (each place only entered once)
data_all2 <- data_all %>%
  mutate(study.ctry = ifelse(aid == "375", "Yemen; Indian Ocean Territories; Australia; Chagos - British Indian Ocean Territory; Maldives; Seychelles; Kenya; United Republic of Tanzania; Mozambique; India; Indonesia; Cambodia; Myanmar; Thailand; Oman; United Arab Emirates; Qatar; Bahrain; Kuwait; Iraq; Iran; Sri Lanka; South Africa; Djibouti; Eritrea; Sudan; Egypt; Israel; Jordan; Saudi Arabia; Comoros; Madagascar; Mauritius; France -Mayotte; France -Reunion",study.ctry))

# AID 344 is technically 2019, but was a 2018 paper, need to update the year
data_all2 <-data_all2 %>% 
  mutate(Year.of.publication=gsub("2019","2018",Year.of.publication))  # 2019 should be 2018

#Intervention Updates
# remove 8. Research and Monitoring as an intervention entirely, and adjust numbers
data_all2 <-data_all2 %>% 
  filter(Int_cat!="8. Research & monitoring")%>% 
  mutate_at(vars(Int_cat,Intervention.subcategory), ~gsub("^9","8",.)) %>% 
  mutate_at(vars(Int_cat,Intervention.subcategory), ~gsub("^10","9",.))  

# Intervention Capitalization
data_all2 <-data_all2 %>% 
  mutate(Int_cat=gsub("1. Land/water management","1. Land/Water Management",Int_cat), 
    Int_cat=gsub("2. Species management","2. Species Management",Int_cat), 
    Int_cat=gsub("3. Awareness raising","3. Awareness Raising",Int_cat),
    Int_cat=gsub("4. Enforcement & protection","4. Enforcement & Prosecution",Int_cat), # ALSO needed to change this name back 
        #not sure how it became "protection"... I think I switched at some point by accident?
    Int_cat=gsub("5. Livelihood, economic, and other incentives","5. Livelihood, Economic, & Other Incentives",Int_cat),
    Int_cat=gsub("6. Conservation designation & planning","6. Conservation Designation & Planning",Int_cat),
    Int_cat=gsub("7. Legal & policy frameworks","7. Legal & Policy Frameworks",Int_cat),
    Int_cat=gsub("8. Education & training","8. Education & Training",Int_cat),
    Int_cat=gsub("9. Institutional/organizational development","9. Institutional/Organizational Development",Int_cat)) 

# fix data in country column
  ## the "admin" column in ne_countries joins to the country shapes from Natural Earth by name. This can get tricky because the names have to match exactly, which is what I do below
data_all2 <- data_all2 %>%
  mutate(
         study.ctry=gsub(",",";",study.ctry),  # replace "," with ";" to help with splitting
         study.ctry=gsub("Bahamas","The Bahamas",study.ctry),
         study.ctry=gsub("Mauritiana","Mauritania",study.ctry),
         study.ctry=gsub("Saint Vincent And The Grenadines","Saint Vincent and the Grenadines",study.ctry),
         study.ctry=gsub("Timor-Leste","East Timor",study.ctry),
         study.ctry=gsub("Korea; South","South Korea",study.ctry),
         study.ctry=gsub("Turks and Caicos","Turks and Caicos Islands",study.ctry),
         study.ctry=gsub("Tanzania; United Republic Of","United Republic of Tanzania",study.ctry, fixed=TRUE),
         # study.ctry=gsub("United Republic of Tanzania United Republic Of","United Republic of Tanzania",study.ctry, fixed=TRUE),
         study.ctry=gsub("Commonwealth of the Northern Mariana Islands","Northern Mariana Islands",study.ctry),
         study.ctry=gsub("Taiwan; Province Of China","Taiwan",study.ctry),
         study.ctry=gsub("Cote D'Ivoire","Ivory Coast",study.ctry),
         study.ctry=gsub("United States","United States of America",study.ctry,fixed=TRUE),
         study.ctry=gsub("USA","United States of America",study.ctry),
         study.ctry=gsub("Virgin Islands","United States Virgin Islands",study.ctry,fixed=TRUE),
         study.ctry=gsub("U.S. United States Virgin Islands","United States Virgin Islands",study.ctry,fixed=TRUE),
         study.ctry=gsub("British United States Virgin Islands","British Virgin Islands",study.ctry,fixed=TRUE),
         study.ctry=gsub("Viet Nam","Vietnam",study.ctry),
         study.ctry=gsub("Comoros","; Comoros",study.ctry,fixed=TRUE), # somehow lost its divider
         ## Would Like a better Name / Map / Disputed... come back to
         study.ctry=gsub("Chagos - British Indian Ocean Territory","British Indian Ocean Territory",study.ctry),
         study.ctry=gsub("Chagos currently disputed between UK and Republic of Mauritius","British Indian Ocean Territory",study.ctry),
         study.ctry=gsub("France -Mayotte","France",study.ctry), 
         study.ctry=gsub("France -Reunion","France",study.ctry), 

  ## Want to check back on name changes / the way I'm referring to them
         study.ctry=gsub("Commonwealth of the Northern Mariana Islands","Northern Mariana Islands",study.ctry),
         study.ctry=gsub("Lao People's Democratic Republic","Laos",study.ctry),
         ) 

#Update the country data file to match two of the sites:
country <- country %>%
  mutate(Country=gsub("Bahamas","The Bahamas",Country)) %>% 
  mutate(code=gsub("BHM","BHS",code)) %>% #Bahamas had a dif country code in these two datasets
    #to match the name change above for this country
  add_row(Country="British Indian Ocean Territory", Region= "Asia", code= "IOT", Subregion= "Southern Asia") %>% 
    # Note here: I picked Asia and Southern Asia because of the proximity to the Maldives
      # Next Closest were Mauritius and Seychelles, Technically Africa... 
  add_row(Country="Indian Ocean Territories", Region= "Asia", code= "IOA", Subregion= "Southern Asia") 
      # Christmas Island and Cocos - right under Indo


```


# NEW Quick Checks to make sure data is sorting correctly - Intervention and Outcomes

```{r eval=T}
         
#quick checks
unique(data_all2$Int_cat)  # 9 Interventions (we took #8 out)
unique(data_all2$Outcome_cat) # 7 outcomes
sort(unique(data_all2$Intervention.subcategory)) # 32 sub-interventions (in int_sub_list)
  # Only 26 sub-interventions were coded for
sort(unique(data_all2$Outcome.subcategory)) # 43 sub-outcomes (bc we added in Catch/Yield x2)
  # Only 41 sub-interventions were coded for

# those that were not observed
int_list$Int_cat_orig[!int_list$Int_cat_orig%in%data_all2$Int_cat] # 8. Research and monitoring
int_sub_list$int_sub[!int_sub_list$int_sub%in%data_all2$Intervention.subcategory] # 6 sub-interventions. Correct: 32-26=6
out_list$Outcome_cat_orig[!out_list$Outcome_cat_orig%in%data_all2$Outcome_cat] #correct, 0 bc all were coded for
out_sub_list$out_sub[!out_sub_list$out_sub%in%data_all2$Outcome.subcategory] # 2 sub-outcomes. Correct: 43-41=2

# incorrect values entered (all should be zero)
data_all2$Int_cat[!data_all2$Int_cat%in%int_list$Int_cat_orig] #0
data_all2$Intervention.subcategory[!data_all2$Intervention.subcategory%in%int_sub_list$int_sub] #0
data_all2$Outcome_cat[!data_all2$Outcome_cat%in%out_list$Outcome_cat_orig] #0
data_all2$Outcome.subcategory[!data_all2$Outcome.subcategory%in%out_sub_list$out_sub] #0
  # Correct - all are 0!

#new quick checks
unique(data_all2$Int_cat)  # 9 interventions, #1-9
unique(data_all2$Outcome_cat) # 7 outcomes, #1-7
sort(unique(data_all2$Intervention.subcategory)) # 26 sub-interventions coded - no.1-9
sort(unique(data_all2$Outcome.subcategory)) # 41 sub-outcomes coded, no.1-7.

# Get full intervention list
  int_list <- data_all2 %>%
    ungroup() %>%
    distinct(Int_cat) %>%
    rename(int_val=Int_cat) %>% 
    arrange(int_val)
  out_list <- data_all2 %>%
    ungroup() %>%
    distinct(Outcome_cat) %>%
    rename(out_val=Outcome_cat) %>% 
    arrange(out_val)
# Get full sub-intervention list
  int_sub_list <- data_all2 %>%
    ungroup() %>%
    distinct(Intervention.subcategory) %>%
    rename(int_val=Intervention.subcategory) %>% 
    arrange(int_val)
  out_sub_list <- data_all2 %>%
    ungroup() %>%
    distinct(Outcome.subcategory) %>%
    rename(out_val=Outcome.subcategory) %>% 
    arrange(out_val)
```

# TROUBLE-SHOOTING - 1/24/24!!!
here, I was troubleshooting by checking different outcome categories for coding. For example, I checked cat "1c. Yield/CPUE" and decided that some of this category should be coded in category 2, AND re-coded this category to be double-coded with 5b! I also re-checked many other outcome categories, and fixed ones that had issues (e.g. 1e. behavior, 1k body conditions, 2b species diversity, culture, knowledge, etc.)

The below script is commented off, but kept the code for how to easily check these categories, and export when I needed to dive deeper.

```{r eval=T}

# # View all Outcome Subcategories!
# unique(data_all2$Outcome.subcategory)

# # CPUE (1c)
# CPUE_outcomes <- data_all2 %>% 
#   filter(Outcome.subcategory=="1c. Yield/CPUE")
# View(CPUE_outcomes)
# write.csv(CPUE_outcomes,paste0(tabledir,today.date,"_CPUE_outcomes.csv"))

# # 1e.BEHAVIOR!
# Behavior_out <- data_all2 %>% 
#   filter(Outcome.subcategory=="1e. Behavior")
# # View(Behavior_out)
# # write.csv(Behavior_out,paste0(tabledir,today.date,"_1e.csv"))
# # Now going to Get EVERY Row of data for each of the aids!
# Behavior_out_aid <- Behavior_out %>% 
#   select(aid) %>%
#   distinct(aid)
# # View(Behavior_out_aid)
# 
# # Coral Attachment Issues: Outcome 1k. Body Conditions. and 1l. Adaptability - Coral studies and issues!
# Coral_issues <- data_all2 %>% 
#   filter(Outcome.subcategory=="1k. Body Conditions"|
#            Outcome.subcategory=="1l. Adaptability")
# # View(Coral_issues)
# # write.csv(Coral_issues,paste0(tabledir,today.date,"_1kand1l_outcomes.csv"))
# 
# # 2b. Species Diversity - Undercoded
# ## For Species Diversity, I will be pulling out SPECIFIC AIDs First (to check those)
# Diversity_issues <- data_all2 %>% 
#   filter(aid=="508"|
#            aid=="196"|
#            aid=="193"|
#            aid=="606"|
#          )
# # View(Diversity_issues)
# # write.csv(Diversity_issues,paste0(tabledir,today.date,"_Diversity_outcomes.csv"))
# # Now I really need to Search for ALL Species Diversity Papers - GO back and do a complete run-through
# Diversity_CODED <- data_all2 %>% 
#   filter(Outcome.subcategory=="2b. Species Diversity") %>% 
#   select(aid) %>%
#   distinct(aid)
# # View(Diversity_CODED)
# # write.csv(Diversity_CODED,paste0(tabledir,today.date,"_diversity.csv"))
# 
# # NEXT, I will want to pull out the Social Outcome papers, and get all of their AIDS
# 
# # KNOWLEDGE (6a)!
# know_out <- data_all2 %>% 
#   filter(Outcome.subcategory=="6a. Knowledge")
# # View(know_out)
# # write.csv(know_out,paste0(tabledir,today.date,"_6a_knowledge.csv"))
# 
# # Behavior/Response to new practice (6b)!
# behave_out <- data_all2 %>% 
#   filter(Outcome.subcategory=="6b. Behavior/response to new practices or technologies")
# # View(behave_out)
# # write.csv(behave_out,paste0(tabledir,today.date,"_6b_behavior.csv"))
# 
# # Culture(5h) - also looking for WTP
# culture_out <- data_all2 %>% 
#   filter(Outcome.subcategory=="5h. Culture")
# # View(culture_out)
# # write.csv(culture_out,paste0(tabledir,today.date,"_5h_culture.csv"))

#CANANDA and RUSSIA as COUNTRIES!!
# polar_countries <- data_all2 %>%
#   filter(aid=="375")
# View(polar_countries)
# write.csv(polar_countries,paste0(tabledir,today.date,"_polar_countries.csv"))
```

# Heat map function
Creates a heat map from the OESM accepted articles, based on intervention and outcome categories and subcategories

Under # Create Heatmap, the "geom_text" line adds text (numbers) on each heat map cell. We #ed that line for the first OEGM paper, since it was only a subsample of the literature, and thus numbers themselves could be misleading. Similarly, 

In the future, we should be able to make this heat map interactive with plotly (see https://www.r-graph-gallery.com/79-levelplot-with-ggplot2.html)

```{r eval=T}
#--- Heat map function ----
my_heat_map <- function (.data,intc, outc, high.col="#2171b5") {
  
# don't know why... but this works
  .data$intc<- as.vector(.data %>%  pull(intc))
  .data$outc<- as.vector(.data %>%  pull(outc))

# Set full intervention list type  
if(intc=="Int_cat"){int_list_full=int_list}
if(intc=="Intervention.subcategory"){int_list_full=int_sub_list}
if(outc=="Outcome_cat"){out_list_full=out_list}
if(outc=="Outcome.subcategory"){out_list_full=out_sub_list}

# Get unique article ID, int. and out. list (and sum of articles)
  typology_dat <- .data %>% 
    select(aid, intc, outc) %>% 
    filter(intc!="" & !is.na(intc)) %>%  # just in case
    distinct() %>% 
    full_join(int_list_full,by =c("intc"="int_val")) %>% 
    full_join(out_list_full,by =c("outc"="out_val")) %>% 
    group_by(intc) %>% 
    mutate(int_val=paste0(intc)) %>% 
      # mutate(int_val=paste0(intc," (",n_distinct(aid,na.rm = T),")")) %>%  #adds article counts to int names
    group_by(outc) %>% 
    mutate(out_val=paste0(outc)) %>% 
      # mutate(out_val=paste0(outc," (",n_distinct(aid,na.rm = T),")")) %>% #adds article counts to out names
    ungroup() %>% 
    select(-c(intc,outc)) 
  
  # Get expanded intervention-outcome list for this dataset
  int_list <- typology_dat %>%
    ungroup() %>%
    filter(int_val!="NA (0)") %>% 
    distinct(int_val) %>%
    arrange(int_val)
  out_list <- typology_dat %>%
    ungroup() %>%
    distinct(out_val) %>%
    filter(out_val!="NA (0)") %>% 
    arrange(out_val)
  io_list <- expand.grid(int_list$int_val,out_list$out_val) %>% 
    rename(int_val=Var1,out_val=Var2)

#head(io_list)
  
  #gather data and get counts 
  io_counts <<- typology_dat %>%
    group_by(int_val, out_val) %>% 
    count() %>%
    mutate(pct=n/num.studies*100) %>% ###JUST added this in... SEE WHAT IT DOES!!!
    full_join(io_list,by = c("int_val", "out_val")) %>%   # inserts missing combinations
    filter(int_val!="NA (0)" &  out_val!="NA (0)") %>% 
    mutate(n=replace_na(n,0)) %>%
    mutate(pct=replace_na(pct,0)) %>% # JUST added this in,  - fixes NAs
    select(-n) %>% # JUST ADDED - Dropping COLUMN N so r doesnt get confused!!!
    ungroup() %>% 
    mutate(int_val=factor(int_val,levels=mixedsort(int_list$int_val)))  # set int list in right order
  
  # head(io_counts)
  # nrow(int_list)*nrow(out_list)==nrow(io_counts) # quick check (should be true)
  
# Create Heatmap
  heat.map <<- ggplot(data=io_counts, aes(x=int_val,y=reorder(out_val, desc(out_val)),fill=pct)) + #fill changed from n to pct
      geom_tile(color="gray90",size=0.1) +
      # geom_text(aes(label=pct),show.legend = F) + # adds percents into cells
    scale_fill_gradient2(low="#f7fbff",high=high.col,name="Percent of Studies",
        na.value="black", limits=c(0,max(io_counts$pct))) +   #changed n to pct
      coord_equal() +
      theme(axis.ticks=element_line(size=0.3),
        axis.text=element_text(size=10),
        axis.text.x = element_text(angle=45,hjust=0,vjust=1),
        axis.text.y = element_text(angle=0,hjust=0,vjust=0),
        legend.title=element_text(size=10),
        legend.title.align=1,
        legend.text=element_text(size=8),
        legend.margin = margin(grid::unit(0,"cm")),
        legend.position ="bottom",
        legend.direction ="horizontal",
        legend.key.size=grid::unit(1, "cm"),
        legend.key.width=grid::unit(1.5, "cm"), #1.5 cm - longer but not full!
        plot.background=element_blank(),
        panel.border=element_blank(),
        plot.title=element_text(hjust=0,size=12,face="bold"),
        text=element_text(family="sans")) +  # "serif"=TN Roman, "sans" = Arial
      scale_x_discrete(position = "top") +
      scale_y_discrete(position = "right") 
      #  labs(x="Conservation Intervention", y="Outcome", title ="All ecosystems") +
}
```

# Create heat maps 
```{r eval=T}
#--- Create maps ----
# All ecosystems
my_heat_map(data_all2,"Int_cat","Outcome_cat")
io_counts.all <- io_counts
(heat.map.all <- heat.map +
    labs(x="Conservation Intervention", y="Outcome", title ="All Ecosystems"))
ggsave(paste0(plotdir,today.date,'_int_out_map.png'),width = 8,height = 8)

# All ecosystems - Intervention subcategory X Outcome
my_heat_map(data_all2,"Intervention.subcategory", "Outcome_cat")
io_counts.subint <- io_counts
(heat.map.subint <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="All Ecosystems"))
ggsave(paste0(plotdir,today.date,'_sub.int_out_map.png'),width = 16,height = 8)

# All ecosystems - Intervention  X Outcome subcategory
my_heat_map(data_all2,"Int_cat", "Outcome.subcategory")
io_counts.subint <- io_counts
(heat.map.subint <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="All Ecosystems"))
ggsave(paste0(plotdir,today.date,'_int_sub.out_map.png'),width = 8,height = 16)

# All ecosystems - Intervention subcategory X Outcome subcategory
my_heat_map(data_all2,"Intervention.subcategory", "Outcome.subcategory")
io_counts.subintout <- io_counts
(heat.map.subint <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="All Ecosystems"))
ggsave(paste0(plotdir,today.date,'_sub.int_sub.out_map.png'),width = 10,height = 12)

# Coral
my_heat_map(filter(data_all2,coral==1),"Int_cat","Outcome_cat", high.col = "coral3")
io_counts.coral <- io_counts
(heat.map.coral <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Coral"))

# Mangrove
my_heat_map(filter(data_all2,mangrove==1),"Int_cat","Outcome_cat", high.col = "orange2")
io_counts.mangrove <- io_counts
(heat.map.mangrove <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Mangrove")) 

# Seagrass
my_heat_map(filter(data_all2,seagrass==1),"Int_cat","Outcome_cat", high.col = "green4")
io_counts.seagrass <- io_counts
(heat.map.seagrass <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Seagrass")) 

# Ecosystem maps on same scale
max.val <- max(io_counts.mangrove$pct,io_counts.coral$pct,io_counts.seagrass$pct)
plot_grid(heat.map.coral + scale_fill_gradient2(low="#f7fbff",high= "coral3",name="Percent of Studies",na.value="black", limits=c(0,max.val)),
          heat.map.seagrass + scale_fill_gradient2(low="#f7fbff",high= "green4",name="Percent of Studies",na.value="black", limits=c(0,max.val)),
          heat.map.mangrove + scale_fill_gradient2(low="#f7fbff",high= "orange2",name="Percent of Studies",na.value="black", limits=c(0,max.val)),
          labels=letters[1:3], ncol = 3, nrow = 1, hjust=-1, align = "hv")
ggsave(paste0(plotdir,today.date,'_habitat_int_out_map.png'),width = 17,height = 8)

# NOTE: maps might not show up below, but check folders - they should still come out fine
```

# Create STONY BROOK Heatmaps - Coral Reefs!!!
```{r eval=T}
#--- Create CORAL maps ----
#FIRST, Update Function for PERCENTAGES!!!
#--- Heat map function ----
coral_heat_map <- function (.data,intc, outc, high.col="coral3") {
  
# don't know why... but this works
  .data$intc<- as.vector(.data %>%  pull(intc))
  .data$outc<- as.vector(.data %>%  pull(outc))

# Set full intervention list type  
if(intc=="Int_cat"){int_list_full=int_list}
if(intc=="Intervention.subcategory"){int_list_full=int_sub_list}
if(outc=="Outcome_cat"){out_list_full=out_list}
if(outc=="Outcome.subcategory"){out_list_full=out_sub_list}

# Get unique article ID, int. and out. list (and sum of articles)
  typology_dat <- .data %>% 
    select(aid, intc, outc) %>% 
    filter(intc!="" & !is.na(intc)) %>%  # just in case
    distinct() %>% 
    full_join(int_list_full,by =c("intc"="int_val")) %>% 
    full_join(out_list_full,by =c("outc"="out_val")) %>% 
    group_by(intc) %>% 
    mutate(int_val=paste0(intc)) %>% 
      # mutate(int_val=paste0(intc," (",n_distinct(aid,na.rm = T),")")) %>%  #adds article counts to int names
    group_by(outc) %>% 
    mutate(out_val=paste0(outc)) %>% 
      # mutate(out_val=paste0(outc," (",n_distinct(aid,na.rm = T),")")) %>% #adds article counts to out names
    ungroup() %>% 
    select(-c(intc,outc)) 
  
  # Get expanded intervention-outcome list for this dataset
  int_list <- typology_dat %>%
    ungroup() %>%
    filter(int_val!="NA (0)") %>% 
    distinct(int_val) %>%
    arrange(int_val)
  out_list <- typology_dat %>%
    ungroup() %>%
    distinct(out_val) %>%
    filter(out_val!="NA (0)") %>% 
    arrange(out_val)
  io_list <- expand.grid(int_list$int_val,out_list$out_val) %>% 
    rename(int_val=Var1,out_val=Var2)

#head(io_list)
  
  #gather data and get counts 
  io_counts <<- typology_dat %>%
    group_by(int_val, out_val) %>% 
    count() %>%
    mutate(pct=n/num.studies*100) %>% ###JUST added this in... SEE WHAT IT DOES!!!
    full_join(io_list,by = c("int_val", "out_val")) %>%   # inserts missing combinations
    filter(int_val!="NA (0)" &  out_val!="NA (0)") %>% 
    mutate(n=replace_na(n,0)) %>%
    mutate(pct=replace_na(pct,0)) %>% # JUST added this in,  - fixes NAs
    select(-n) %>% # JUST ADDED - Dropping COLUMN N so r doesnt get confused!!!
    ungroup() %>% 
    mutate(int_val=factor(int_val,levels=mixedsort(int_list$int_val)))  # set int list in right order
  
  # head(io_counts)
  # nrow(int_list)*nrow(out_list)==nrow(io_counts) # quick check (should be true)
  
# Create Heatmap
  heat.map <<- ggplot(data=io_counts, aes(x=int_val,y=reorder(out_val, desc(out_val)),fill=pct)) + #fill changed from n to pct
      geom_tile(color="gray90",size=0.1) +
      geom_text(aes(label=round(pct)),show.legend = F) + # ADDING THIS IN FOR WORKSHOP!!!adds percents into cells
    scale_fill_gradient2(low="#f7fbff",high=high.col,name="Percent of Studies",
        na.value="black", limits=c(0,max(io_counts$pct))) +   #changed n to pct
      coord_equal() +
      theme(axis.ticks=element_line(size=0.3),
        axis.text=element_text(size=10),
        axis.text.x = element_text(angle=45,hjust=0,vjust=1),
        axis.text.y = element_text(angle=0,hjust=0,vjust=0),
        legend.title=element_text(size=10),
        legend.title.align=1,
        legend.text=element_text(size=8),
        legend.margin = margin(grid::unit(0,"cm")),
        legend.position ="bottom",
        legend.direction ="horizontal",
        legend.key.size=grid::unit(1, "cm"),
        legend.key.width=grid::unit(1.5, "cm"), #1.5 cm - longer but not full!
        plot.background=element_blank(),
        panel.border=element_blank(),
        plot.title=element_text(hjust=0,size=12,face="bold"),
        text=element_text(family="sans")) +  # "serif"=TN Roman, "sans" = Arial
      scale_x_discrete(position = "top") +
      scale_y_discrete(position = "right") 
      #  labs(x="Conservation Intervention", y="Outcome", title ="All ecosystems") +
}


# Coral
coral_heat_map(filter(data_all2,coral==1),"Int_cat","Outcome_cat")
io_counts.coral <- io_counts
(heat.map.coral <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Coral"))
ggsave(paste0(plotdir,today.date,'_CORAL_int_out_map.png'),width = 8,height = 8)

# Coral - Intervention subcategory X Outcome
coral_heat_map(filter(data_all2,coral==1),"Intervention.subcategory", "Outcome_cat")
io_counts.subint <- io_counts
(heat.map.subint <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Coral"))
ggsave(paste0(plotdir,today.date,'_CORAL_sub.int_out_map.png'),width = 16,height = 8)

# Coral - Intervention  X Outcome subcategory
coral_heat_map(filter(data_all2,coral==1),"Int_cat", "Outcome.subcategory")
io_counts.subint <- io_counts
(heat.map.subint <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Coral"))
ggsave(paste0(plotdir,today.date,'_CORAL_int_sub.out_map.png'),width = 8,height = 16)

# Coral - Intervention subcategory X Outcome subcategory
coral_heat_map(filter(data_all2,coral==1),"Intervention.subcategory", "Outcome.subcategory")
io_counts.subintout <- io_counts
(heat.map.subint <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Coral"))
ggsave(paste0(plotdir,today.date,'_CORAL_sub.int_sub.out_map.png'),width = 10,height = 12)


```

# World map

# All Habitats World Map

Creates a world map of all habitats

https://ggplot2.tidyverse.org/reference/ggsf.html - geom_sf resource!
 -> https://ggplot2.tidyverse.org/reference/coord_map.html?q=worldmap#ref-examples
 
More about legends:
- https://www.tidyverse.org/blog/2024/02/ggplot2-3-5-0-legends/ 
 
Requires rnaturalearth and tidyverse packages (loaded at the top)

```{r eval=T}
# Download country shapes from ne_countries map
world_countries <- ne_countries(
  scale = 10,
  type = "countries",
  returnclass = "sf")
# class(world_countries) # this tells me that this is an sf file and df - helpful!

# All Habitats  World Map
ctry.all <- data_all2 %>% 
  group_by(aid,study.ctry) %>%
  summarise() %>% 
  filter(!is.na(study.ctry))
head(ctry.all)

# Check cleaned data
unique(ctry.all$study.ctry)

# get no. articles per country (and percentage) to create vector of column names for each country by counting the number of ";" 
    # thus isn't working out well... this gets 18 as the number... but it looks like this highest number is 23 (Australia)
max.ctry <- paste0("ctry",rep(1:max(str_count(ctry.all$study.ctry, ";")+1))) 

# FIX the data with weird names, once in their own rows! 
ctry_sum <- ctry.all %>% 
  mutate(study.ctry=gsub("United Republic of Tanzania Mozambique","United Republic of Tanzania; Mozambique",study.ctry,fixed = TRUE), # need ; 
         study.ctry=gsub("United Republic of Tanzania Comoros","United Republic of Tanzania; Comoros",study.ctry,fixed = TRUE)) %>% 
  separate(study.ctry,max.ctry, sep="; ",fill="right") %>% # fill=right fills blanks with NAs
  gather("X","admin", max.ctry) %>%   #gather is a tidyr function that reshapes columns into key pairs 
      #renames "study.ctry" to "admin"
      #admin is the sub-country column in world_countries dataframe
  filter(!is.na(admin)) %>% 
  filter(!(admin == "")) %>% 
    ### COULD POTENTIALLY MOVE INTO 300s?
  mutate(admin=gsub(".*Hawaii*.","United States of America",admin), # parenthesis () names - no other way
         admin=gsub(".*Palmyra Atoll near Kiribati but owned by United States of America*.","United States of America",admin),
          admin=gsub(".*Tanzania*.","United Republic of Tanzania",admin),
         admin=gsub(".*Guadeloupe*.","France",admin),
         admin=gsub(".*Mayotte*.","France",admin),
         admin=gsub(".*Reunion*.;","France",admin)
  ) %>%
  filter(!(aid == '705')) %>% # need this here to remove aid 705 - paper with no real countries
  ungroup()

ctry_sum.25 <- ctry_sum %>%
  select(-X) %>%
  distinct() %>% # no duplicate aids (e.g. France territories = lumped into France) - this is HUGELY IMPORTANT here!!!
  group_by(admin) 
    #Quick check = AID 10, there were 2 for France - now should only be 1 :)

ctry_sum.5 <- ctry_sum.25 %>%
  count() %>%     #count creates an "n" column
  mutate(pct=round(n/num.studies*100)) %>%   #this creates the "pct" column
  arrange(desc(n))
    #Quick check -> France should have n=3. If n=5, not de-duping correctly in ctry_sum.25

# Countries that need to be fixed
ctry_sum.5$admin[!ctry_sum.5$admin%in%world_countries$admin]
  #Note: the NA country is AID 705 Campbell et al. - I emailed the corresponding author, they did not know the countries...

# join to full world_countries country data with OEGM data in a df
ctry_sum1 <- ctry_sum.5 %>%  # ctry_sum is the data frame and world_countries is the sf 
  full_join(world_countries,by="admin") %>%  # full_join keeps all ROWS (even the n=0 rows!)
  mutate(n=na.replace(n,0)) %>% 
  mutate(pct=na.replace(pct,0))
ctry_sum1$admin[!ctry_sum1$admin%in%world_countries$admin] # any missing?

# join cntry_sum1 with the regions and continents in the old "country" dataset (again, full_join)
ctry_sum2 <- country %>%   
  full_join(ctry_sum1, by = c("code" = "adm0_a3")) %>% 
  select(-Country) %>%
  #select(admin,n,pct,code,Subregion,Region) %>%
  arrange(desc(pct))
ctry_sum2$admin[!ctry_sum2$admin%in%world_countries$admin] # any missing? ###MANY NAs now!

# TURN THE FILE BACK INTO AN SF
ctry_sum3 <- st_as_sf(ctry_sum2)
class(ctry_sum3)
  #SUCCESS ctry_sum3 is an sf! 

# Plot study map
(study_ctry_map <- ggplot(data=ctry_sum3) +
  geom_sf(aes(fill=pct), color=NA) + #note: color=NA takes out country boarders (otherwise grey)
  theme(
        panel.background = element_rect(fill = "#CCCCCC", colour = "#CCCCCC"), 
          #this grey looks deep, but it allows for better contrast with the white than gray90
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border=element_blank(),
        plot.title=element_text(hjust=0,size=12), # face="bold"
        axis.ticks = element_blank(), 
        axis.text = element_blank(),
        axis.title = element_blank(),
        legend.title=element_text(size=10),
        legend.title.align=1,
        legend.title.position = "left", 
        legend.text=element_text(size=8),
        legend.position ="bottom",
        legend.justification.bottom = "center",
        legend.key.width=grid::unit(1.5, "cm"), #1.5 cm - longer but not full!
          # legend.key.width = unit(1, "null"), # not as good
        text=element_text(family="sans") # "serif"=TN Roman, "sans" = Arial
        ) +
  scale_fill_gradient2(
    name = "Percent of Studies",
    low="white",mid="#2171b5",high="#08519c", 
        #the low color here is white - allows for better contrast
        #the mid color here is the high color for the Gap Map
    midpoint=max(ctry_sum1$pct)/2,     #keep ctry_sum1 - doesnt read sum3
    limits=c(0,max(ctry_sum1$pct))) +
 coord_sf(xlim = c(-180, 180), ylim = c(-58, 55.5), expand = FALSE) )
ggsave(paste0(plotdir,today.date,'_study_country_map.png'),width = 9,height = 3.68) #height fitted for specific latitudes
```

# World Maps - Coral, Seagrass, and Mangrove

###NOTE: should try to make world map into a FUNCTIOn like gap map if I want habitat specific maps!

```{r eval=T}
# Coral World Map
# ctry.coral <- data_all2 %>% 
#   filter(coral==1) %>% 
#   group_by(aid,study.ctry) %>%
#   summarise() %>% 
#   filter(!is.na(study.ctry))
# head(ctry.coral)
# 
#     low="white",mid="darksalmon",high="coral3", 
#         #the low color here is white - allows for better contrast
#         #the high color here is the high color for the Gap Map

#GAP MAP COLORS
# # Mangrove
# high.col = "orange2"
# 
# # Seagrass
# high.col = "green4"
```

# Treemapping

Outcome and Intervention tree maps

###NOTE: for website, may want to use https://d3js.org/ - interactive figures, including tree maps!!!
https://observablehq.com/@d3/treemap-stratify?intent=fork

```{r eval=T}
#---- Treemapping ----

# - Interventions
unique(data_all2$Intervention.subcategory)

intervention2 <-data_all2 %>% 
  filter(!is.na(Intervention.subcategory)) %>% 
  select(aid,Int_cat,Intervention.subcategory) %>% 
  group_by(Int_cat) %>% 
  mutate(int.cat=paste0(Int_cat,"\n (",n_distinct(aid),")")) %>% 
  group_by(Int_cat,Intervention.subcategory) %>% 
  mutate(n=n_distinct(aid)) %>% 
  arrange(Intervention.subcategory)

unique(intervention2$int.cat)

png(file=paste0(plotdir,today.date,"_intervention_treemap.png"), width=600, height=600) #switched to .png instead of .pdf
treemap(intervention2,index=c("int.cat","Intervention.subcategory"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="Study interventions")
dev.off()

# - Outcomes
unique(data_all2$Outcome.subcategory)

outcomes2 <-data_all2 %>% 
  filter(!is.na(Outcome.subcategory)) %>% 
  select(aid,Outcome_cat,Outcome.subcategory) %>% 
  group_by(Outcome_cat) %>% 
  mutate(out.cat=paste0(Outcome_cat,"\n (",n_distinct(aid),")")) %>% 
  group_by(Outcome_cat,Outcome.subcategory) %>% 
  mutate(n=n_distinct(aid)) %>% 
  arrange(Outcome.subcategory)
unique(outcomes2$out.cat)

png(file=paste0(plotdir,today.date,"_outcome_treemap.png"), width=600, height=600) #switched to .png instead of .pdf
treemap(outcomes2,index=c("out.cat","Outcome.subcategory"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="Study Outcomes")
dev.off()
  # SOMETHING isn't working here - the figure doesn't accurately represent the percentages!!!
```

^NOTE, the above treemap is NOT working from a size representation perspective

#Treemapping - trying ANOTHER treemap

## IN PROGRESSS

```{r eval=T}
#---- Treemapping ----
# ------------NEW CODE ATTEMPTS

# # Intervention Graphic
# (pInt_time_gps <- ggplot(Int_time_gps)  + 
#     geom_line(aes(x = Year.of.publication, y = val, group = Intervention, colour = Intervention, linetype=Intervention), size = 1.3)  +
#     labs(
#     scale_color_manual(values=c(      # uses Okabe-Ito colors - color-blind friendly!
#       "All Interventions" = "#000000",    #black Okabe-Ito
#       "1. Land/Water Management" = "#0072B2", #blue Okabe-Ito
#       "2. Species Management" = "#56B4E9",   #Sky Blue Okabe-Ito
#       "3. Awareness Raising" = "#009E73",    #Bluish Green Okabe-Ito
#       "4. Enforcement & Protection" = "#F0E442",    # Yellow Okabe-Ito
#       "5. Livelihood, Economic, & Other Incentives" = "#E69F00",  #Orange Okabe-Ito
#       "6. Conservation Designation & Planning" = "#D55E00", #Vermillion Okabe-Ito
#       "7. Legal & Policy Frameworks" =  "#BE0032", # from kelly by grafify - good on color-blindness.com
#       "8. Education & Training" = '#882255', #wine - extra color by DIG - good on color-blindness.com
#       "9. Institutional/Organizational Development" = "#CC79A7" )) #reddish purple Okabe-Ito
#       ))

  


# ------ Outcomes ATTEMPT DIG---------

### Getting the data sorted
#NOTE: may require ggforce package, AND colorspace package - NEED TO RE-ADD TO THE TOP OF THE SCRIPT
  
unique(data_all2$Outcome.subcategory)

outcomes2 <-data_all2 %>% 
  filter(!is.na(Outcome.subcategory)) %>% 
  select(aid,Outcome_cat,Outcome.subcategory) %>% 
  group_by(Outcome_cat) %>% 
  mutate(out.cat=paste0(Outcome_cat,"\n (",round(n_distinct(aid)/num.studies*100),"%)")) %>%  #updated to make this a %
  group_by(Outcome_cat,Outcome.subcategory) %>% 
  mutate(n=n_distinct(aid)) %>% 
  ungroup() %>%
  group_by(Outcome_cat) %>%
  mutate(out.paper.n=n_distinct(aid)) %>%  #ALSO make this a column, and check my MATH! #percentages PASSED THE CHECK!
  ungroup() %>%
  arrange(Outcome_cat,Outcome.subcategory)
unique(outcomes2$out.cat)

outcomes_tidy <- outcomes2 %>% 
  ungroup() %>% 
  select(-aid) %>%
  distinct() %>%
  group_by(Outcome.subcategory) %>%
  mutate(fill = Outcome_cat,
      fill=gsub("1. Population/Species", "#0072B2",fill),  #blue Okabe-Ito
      fill=gsub("2. Ecological Community", "#56B4E9",fill),   #Sky Blue Okabe-Ito
      fill=gsub("3. Ecosystem Function", "#009E73",fill),    #Bluish Green Okabe-Ito
      fill=gsub("4. Ecosystem Services", "#F0E442",fill),    # Yellow Okabe-Ito
      fill=gsub("5. Human Wellbeing", "#E69F00",fill),      #Orange Okabe-Ito
      fill=gsub("6. Knowledge and Behavior", "#D55E00",fill), #Vermillion Okabe-Ito
      fill=gsub("7. Governance", "#CC79A7",fill))  #reddish purple Okabe-Ito



#-----DIF attempts at making a COLOR -----#

# minimum and maximum number of outcome subcategory papers (n) in 1 category
  #sort outcomes_tidy by n
min.out <- min(outcomes_tidy$n)
max.out <- max(outcomes_tidy$n)

## manually add colors
# hues
hues <- c(50, 100, 250, 300) # brown, green, blue, purple

#ORIGINAL: filcols <- c(vapply(filcols, function(x) c(lighten(x, .9), lighten(x, .6), lighten(x, .3), x), character(4)))
#filcols2 <- c(vapply(filcols, function(x) c(lighten(x, .9), lighten(x, .8),lighten(x, .75),lighten(x, .7),lighten(x, .65),lighten(x, .6),lighten(x, .55),lighten(x, .5),lighten(x, .4),lighten(x, .35),lighten(x, .3),lighten(x, .2),lighten(x, .1), x), character(14)))

#-----DIF attempts at making a COLOR -----#




# turn pop density into color
outcomes_tidy_color <- outcomes_tidy %>%
  group_by(out.cat) %>%
  mutate(value = (n-min.out)/(max.out-min.out)) %>%
  ungroup()
#### DID NOT FINISH - DO NOT KNOW WHAT TO DO NEXT!!!

#hues <- outcomes_tidy_color$fill

ggplot(outcomes_tidy_color, aes(area = n, subgroup = out.cat, fill = value, label = Outcome.subcategory)) + #fill = value gives gradients of color based on value column!
  geom_treemap() + # color = "white", size = 0.5*.pt, alpha = NA
  geom_treemap_subgroup_text(     #treemaps are backwards - "subgroup" here is the broader outcome group
    family = "sans",
    place = "centre", 
    colour = "white", 
    alpha = 0.5,
    fontface = "italic",
    grow = TRUE,
    # reflow = TRUE,
    min.size = 0
  ) +
  geom_treemap_subgroup_border(color = "white") +
  geom_treemap_text(
    aes(label = Outcome.subcategory),
    family = "sans",
    place = "centre",
    color = "black",
    grow = FALSE
  ) +
  # coord_cartesian(clip = "off") + # I don't know what this does
  # guides(colour = "none", fill = "none") + # I don't know what this does
  scale_color_manual(values=fill) +
    # scale_fill_continuous(fill=fill) +
    # scale_fill_identity() + # I don't know what this does
  labs(title = "Treemap of Conservation Outcomes") + 
  theme(
        plot.title=element_text(hjust=0,size=12), # face="bold"
        text=element_text(family="sans"), # "serif"=TN Roman, "sans" = Arial
        legend.title=element_blank(), # no legend
        ) 
  # scale_color_manual(values=fill)
  # scale_color_manual(values=outcomes_tidy_color$fill)
ggsave(paste0(plotdir,today.date,'_intervention_treemap_INPROG.png'),width = 10,height = 10)





# ---- OLD Outcomes Figure, but TWEAKED FOR MY COLORS!!!

png(file=paste0(plotdir,today.date,"_outcome_treemap_BETTER.png"), width=600, height=600) 
treemap(outcomes_tidy_color,
        index=c("out.cat","Outcome.subcategory"),
        vSize="n",
        vColor = "fill", #means the vColor column is a vector in #RRGGBB format
        type="color", #means the vColor column is a vector in #RRGGBB format
          # range = ____ , #range of the color values scale
                #ANOTHER color OPTION (can come back and try?)
                  # vColor = "value", #column in my df
                  # type="value", #means the vColor column is numeric!
                  # palette("fill"), #numeric value type REQUIRES Palette
                      # palette=terrain.colors(10) # e.g. 
        fontsize.labels = c(20,11), # draw all labels at fontsizes - cat and subcat,
        lowerbound.cex.labels=.2, # and if they don't fit ^, reduce to a minimum of .2*^ value
        force.print.labels= FALSE, # Forces to print cats, not subcats
        fontcolor.labels=c("white","black"),
        fontface.labels=c("bold","plain"), # or could use "oblique", "bold.italic"
        fontfamily.labels = "sans",   
        overlap.labels=0.8, # tolerance of the overlap between labels. 0 to 1 
            #0 = lower levels not printed if overlap, # 1 means that labels are always printed
        inflate.labels=F,  #don't make bigger if they can expand
        align.labels=list(
          c("center","top"), # cat
          c("left","bottom") # subcat
        ),
        bg.labels=c("transparent"), #background color - high aggregation labels, default to grey ("#CCCCCCDC")
        border.col = "gray90", #matches gap map boarder color
        fontfamily.title = "sans",
        title="Study Outcomes",
        fontsize.title = 15, #Change the font size of the title
       )
dev.off()

```

# Studies over time Figure

Figure of Studies over time, by Intervention and Outcomes

REALLY Useful site for figures: 
- https://clauswilke.com/dataviz/index.html - AMAZING BOOK!!!
    - https://github.com/clauswilke/dataviz - ALL SOURCE CODES ARE HERE!!!
- http://www.sthda.com/english/wiki/ggplot2-essentials 
- manual colors: https://ggplot2-book.org/scales-colour 
- https://ggplot2-book.org/scales-other#sec-scale-manual 

Good resource for Colors:
- https://ggplot2-book.org/scales-colour
- http://www.sthda.com/english/wiki/ggplot2-colors-how-to-change-colors-automatically-and-manually 
- https://rpubs.com/kylewbrown/r-colors
- https://colorbrewer2.org/#type=diverging&scheme=RdYlBu&n=3 

I chose:
- https://siegal.bio.nyu.edu/color-palette/ - Color-blind friendly!
    - https://clauswilke.com/dataviz/color-pitfalls.html#fig:palette-Okabe-Ito 
- I had to choose a few more colors, so I used https://www.color-blindness.com/coblis-color-blindness-simulator/ to make sure they did okay in different color blindness settings!

```{r eval=T}
#---- Studies over time ----
All_time_gps <- data_all2 %>%
  group_by(Year.of.publication) %>% 
  summarise(pub.per.yr= n_distinct(aid)) %>% 
  ungroup() %>% 
  add_row(Year.of.publication = "1995", pub.per.yr = 0) %>% # a numerical value DOESN'T have "" around it! the 0)
      # Note here: there were no 1995 Papers, so I needed to add an entry with 0
  arrange(Year.of.publication) %>% 
  mutate(val=cumsum(pub.per.yr),
         gp="All") %>% 
  select(Year.of.publication,gp,val) %>% 
  filter(!is.na(Year.of.publication))
tail(All_time_gps)

# Interventions
Int_time_gps <-  data_all2 %>%
  group_by(Year.of.publication,Int_cat) %>% 
  summarise(int_per_yr= n_distinct(aid)) %>% 
  spread(Int_cat,value = int_per_yr) %>% 
  ungroup() %>% 
  add_row(Year.of.publication = "1995", "1. Land/Water Management" = 0) %>% # a numerical value DOESN'T have "" around it! the 0)
      # Note here: there were no 1995 Papers, so I needed to add an entry with 0
  mutate_all(funs(replace(., is.na(.), 0))) %>%   #this makes all other NA entries 0!
  arrange(Year.of.publication) %>% 
  mutate_at(vars(-Year.of.publication),funs(cumsum(.))) %>% 
  gather("int_typ","val",-Year.of.publication) %>% 
  bind_rows(All_time_gps %>% rename(int_typ=gp))
tail(Int_time_gps)

# non-elegant way to convert units to factor in order to reorder plot legends
order.gp <- Int_time_gps %>% 
  group_by(int_typ) %>% 
  summarise(order_typ=max(val)) %>% 
  arrange(desc(order_typ)) %>% 
  pull(int_typ)
Int_time_gps <- Int_time_gps %>%  
  mutate(int_typ = factor(int_typ, levels = order.gp)) %>% 
  rename(Intervention=int_typ) %>% 
  mutate(Intervention=gsub("All","All Interventions",Intervention))

#Intervention Graphic
(pInt_time_gps <- ggplot(Int_time_gps)  + 
    geom_line(aes(x = Year.of.publication, y = val, group = Intervention, colour = Intervention), size = 1.3)  +
    ylab("Cumulative frequency") +
  #  scale_x_continuous(name="Year", breaks=seq(1985,2025,5)) +
  #  scale_colour_manual(values=int.cols) +
    ggtitle('Intervention') )
   # scale_y_continuous(limits=c(0,80), breaks=seq(0,80,10), labels=c("0","","20","","40","","60","","80")))


# Intervention Graphic
(pInt_time_gps <- ggplot(Int_time_gps)  + 
    geom_line(aes(x = Year.of.publication, y = val, group = Intervention, colour = Intervention, linetype=Intervention), size = 1.3)  +
    labs(
      x = "Year of Publication",
      y = "Cumulative frequency",
      title = 'Interventions per Year') +
    theme(
        panel.background = element_rect(fill = "gray90", colour = "gray90"), #matches GAP MAP boarder color
        # panel.grid.major = element_blank(), #THIS is the y-ticks on the grid - want to keep
        panel.grid.minor = element_blank(), #THIS is the smaller y-ticks on the grid - can remove!
        # panel.border=element_blank(), #I think this is for if we wanted to separate the two boarders 
        plot.title=element_text(hjust=0,size=12), # face="bold"
        axis.ticks.y = element_blank(), #hides y-axis tick marks
        # axis.text = element_blank(),
        # axis.title = element_blank(),
        legend.title=element_blank(), #element_text(size=10), - I don't think we need the "outcome" - redundant
        legend.title.align=1,
        legend.text=element_text(size=8),
        legend.position ="right",
        text=element_text(family="sans") # "serif"=TN Roman, "sans" = Arial
        ) +
    scale_x_discrete(breaks=c("1995","2000","2005","2010","2015","2018")) +   #discrete bc X is a character/factor
        #  scale_colour_manual(values=int.cols) +
    scale_y_continuous(limits=c(0,171),     #continuous bc y-axis is a NUMERIC
                       breaks=seq(0,150,50)) +   # a labeled tick mark from 0 to 150, every 50
    scale_linetype_manual(values=c(      
      "All Interventions" = "twodash", 
      "1. Land/Water Management" = "solid", 
      "2. Species Management" = "solid",
      "3. Awareness Raising" = "solid",
      "4. Enforcement & Protection" = "solid",
      "5. Livelihood, Economic, & Other Incentives" = "solid",
      "6. Conservation Designation & Planning"= "solid",
      "7. Legal & Policy Frameworks" = "solid",
      "8. Education & Training" = "solid",
      "9. Institutional/Organizational Development" = "solid")) +
    scale_color_manual(values=c(      # uses Okabe-Ito colors - color-blind friendly!
      "All Interventions" = "#000000",    #black Okabe-Ito
      "1. Land/Water Management" = "#0072B2", #blue Okabe-Ito
      "2. Species Management" = "#56B4E9",   #Sky Blue Okabe-Ito
      "3. Awareness Raising" = "#009E73",    #Bluish Green Okabe-Ito
      "4. Enforcement & Protection" = "#F0E442",    # Yellow Okabe-Ito
      "5. Livelihood, Economic, & Other Incentives" = "#E69F00",  #Orange Okabe-Ito
      "6. Conservation Designation & Planning" = "#D55E00", #Vermillion Okabe-Ito
      "7. Legal & Policy Frameworks" =  "#BE0032", # from kelly by grafify - good on color-blindness.com
      "8. Education & Training" = '#882255', #wine - extra color by DIG - good on color-blindness.com
      "9. Institutional/Organizational Development" = "#CC79A7" )) #reddish purple Okabe-Ito
      )
plot_grid(pInt_time_gps)

# Potential Extra Colors
          # "#999999",  # Grey Okabe-Ito
          # '#332288', #indigo - extra color by DIG
          # "#DCD300" #Yellowgreen that may be easier to see?
          # "#882D17" #Red/brown/orange
        # # fishy by grafify - https://grafify-vignettes.netlify.app/colour_palettes.html
          # "#6388b4"
          # "#8cc2ca"
          # "#55ad89"
          # "#c3bc3f"
          # "#ffae34"
          # "#bb7693"
          # "#ef6f6a"
          # "#baa094"
          # "#767676"
        # # kelly by grafify
          # "#0067A5"
          # "#A1CAF1"
          # "#008856"
          # "#8DB600"
          # "#DCD300"
          # "#F3C300"
          # "#F6A600"
          # "#F38400"
          # "#E25822"
          # "#882D17"
          # "#654522"
          # "#F99379"
          # "#BE0032"
          # "#B3446C"
          # "#875692"
          # "#604E97"
          # "#C2B280"
          # "#848482"

# Outcomes
out_time_gps <-  data_all2 %>%
  group_by(Year.of.publication,Outcome_cat) %>% 
  summarise(out_per_yr= n_distinct(aid)) %>% 
  spread(Outcome_cat,value = out_per_yr) %>% 
  ungroup() %>% 
  add_row(Year.of.publication = "1995", "1. Population/Species" = 0) %>%  # note: a name w a space DOES need "" around it
      # Note here: there were no 1995 Papers, so I needed to add an entry with 0
  mutate_all(funs(replace(., is.na(.), 0))) %>%   #this makes all other NA entries 0!
  arrange(Year.of.publication) %>% 
  mutate_at(vars(-Year.of.publication),funs(cumsum(.))) %>% 
  gather("out_typ","val",-Year.of.publication) %>% 
  bind_rows(All_time_gps %>% rename(out_typ=gp))
tail(out_time_gps)

# non-elegant way to convert units to factor in order to reorder plot legends
order.gp <- out_time_gps %>% 
  group_by(out_typ) %>% 
  summarise(order_typ=max(val)) %>% 
  arrange(desc(order_typ)) %>% 
  pull(out_typ)
out_time_gps <- out_time_gps %>%  
  mutate(out_typ = factor(out_typ, levels = order.gp)) %>% 
  rename(Outcome=out_typ) %>% 
  mutate(Outcome=gsub("All","All Outcomes",Outcome))

# Outcome Graphic
(pOut_time_gps <- ggplot(out_time_gps)  + 
    geom_line(aes(x = Year.of.publication, y = val, group = Outcome, colour = Outcome, linetype = Outcome), size = 1.3)  +
    labs(
      x = "Year of Publication",
      y = "Cumulative frequency",
      title = 'Outcomes per Year') +
    theme(
        panel.background = element_rect(fill = "gray90", colour = "gray90"), #matches GAP MAP boarder color
        # panel.grid.major = element_blank(), #THIS is the y-ticks on the grid - want to keep
        panel.grid.minor = element_blank(), #THIS is the smaller y-ticks on the grid - can remove!
        # panel.border=element_blank(), #I think this is for if we wanted to separate the two boarders 
        plot.title=element_text(hjust=0,size=12), # face="bold"
        axis.ticks.y = element_blank(), #hides y-axis tick marks
        # axis.text = element_blank(),
        # axis.title = element_blank(),
        legend.title=element_blank(), #element_text(size=10), - I don't think we need the "outcome" - redundant
        legend.title.align=1,
        legend.text=element_text(size=8),
        legend.position ="right",
        text=element_text(family="sans") # "serif"=TN Roman, "sans" = Arial
        ) +
    scale_x_discrete(breaks=c("1995","2000","2005","2010","2015","2018")) +   #discrete bc X is a character/factor
        #  scale_colour_manual(values=int.cols) +
    scale_y_continuous(limits=c(0,171),     #continuous bc y-axis is a NUMERIC
                       breaks=seq(0,150,50)) +   # a labeled tick mark from 0 to 150, every 50
    scale_linetype_manual(values=c(      
      "All Outcomes" = "twodash", 
      "1. Population/Species" = "solid", 
      "2. Ecological Community" = "solid",
      "3. Ecosystem Function" = "solid",
      "4. Ecosystem Services" = "solid",
      "5. Human Wellbeing" = "solid",
      "6. Knowledge and Behavior" = "solid",
      "7. Governance" = "solid")) +
    scale_color_manual(values=c(      # uses Okabe-Ito colors - color-blind friendly!
      "All Outcomes" = "#000000",    #black Okabe-Ito
      "1. Population/Species" = "#0072B2",  #blue Okabe-Ito
      "2. Ecological Community" = "#56B4E9",   #Sky Blue Okabe-Ito
      "3. Ecosystem Function" = "#009E73",    #Bluish Green Okabe-Ito
      "4. Ecosystem Services" = "#F0E442",    # Yellow Okabe-Ito
      "5. Human Wellbeing" = "#E69F00",      #Orange Okabe-Ito
      "6. Knowledge and Behavior" = "#D55E00", #Vermillion Okabe-Ito
      "7. Governance" =  "#CC79A7"))    #reddish purple Okabe-Ito
  ) 
plot_grid(pOut_time_gps)

#Plot BOTH Interventions and Outcomes together
plot_grid(pInt_time_gps,pOut_time_gps, rel_widths = c(1.2,1))
ggsave(paste0(plotdir,today.date,'_studies_over_time.png'),width = 12,height = 4)

plot_grid(pInt_time_gps, pOut_time_gps, ncol = 1, nrow = 2,rel_widths = c(1.2,1))
ggsave(paste0(plotdir,today.date,'_studies_over_time_2rows.png'),width = 8,height = 7)
```

# Stats Section

This section outputs a lot of the different stats used in the paper. Right now, I am just inputting them by hand, and so definitely would be useful to print out the stats I want to copy/paste and easy access

1. Basic Stats (Paper #s and %s)
```{r eval=T}
# --- Percentages --- #
# test <-  data_all2 %>%
#   select(aid, Int_cat, Intervention.subcategory, Outcome_cat,Outcome.subcategory)
# List of data headings
# head(data_all2,0)

# Total papers in Full Text Screening
length(unique(all.data$Article.ID))

# Total Rejected Full-Text Papers
num.rejects <- length(unique(Reject_data$aid))
print(num.rejects)

# Reasons for Rejection

## List of data headings
# head(Reject_data,0)
## Note: these DO contain overlap, ie. some studies have multiple reasons for rejection!

## Could_not_locate
Reject_data %>%
  filter(Could_not_locate==1) %>% 
  summarise(Why_rejected="Could not Locate", num=n_distinct(aid), pct=num/num.rejects*100) 
## Not_accessible
Reject_data %>%
  filter(Not_accessible==1) %>% 
  summarise(Why_rejected="Not accessible", num=n_distinct(aid), pct=num/num.rejects*100)
## Non_English
Reject_data %>%
  filter(Non_English==1) %>% 
  summarise(Why_rejected="Non English Language", num=n_distinct(aid), pct=num/num.rejects*100) 
## Duplicate
Reject_data %>%
  filter(Duplicate==1) %>% 
  summarise(Why_rejected="Duplicate", num=n_distinct(aid), pct=num/num.rejects*100) 
# Important: I need to get the TOTAL number of Articles in the above 4 categories for the ROSES Diagram (aka need to make sure I am accounting for potential overlap)
Reject_data %>% 
  filter(Could_not_locate + Not_accessible + Non_English + Duplicate == 1) %>% 
  summarise(Why_rejected="TOP Roses Cat: 779 - Y",num=n_distinct(aid), pct=num/num.rejects*100)

## Review_or_MA
Reject_data %>%
  filter(Review_or_MA==1) %>% 
  summarise(Why_rejected="Reviews/Meta-Analysis", num=n_distinct(aid), pct=num/num.rejects*100) 
## Doesnt_fit_PICO
Reject_data %>%
  filter(Doesnt_fit_PICO==1) %>% 
  summarise(Why_rejected="Doesn't fit PICO or Inclusion Criteria", num=n_distinct(aid), pct=num/num.rejects*100) 
## Other Reason
Reject_data %>%
  filter(OtherReason==1) %>% 
  summarise(Why_rejected="Other Reason", num=n_distinct(aid), pct=num/num.rejects*100)
# Important: I need to get the TOTAL number of Articles in the above 3 categories for the ROSES Diagram (aka need to make sure I am accounting for potential overlap)
Reject_data %>% 
  filter(Review_or_MA + OtherReason + Doesnt_fit_PICO == 1) %>% 
  summarise(Why_rejected="TOP Roses Cat: 779 - Y",num=n_distinct(aid), pct=num/num.rejects*100)

# Important: I need to get the TOTAL number of ALL REJECTED Articles in the above 7 categories for the ROSES Diagram (aka ALL Full-text rejects - check to make sure the numbers match up)
Reject_data %>% 
  filter(Could_not_locate + Not_accessible + Non_English + Duplicate + Review_or_MA + OtherReason + Doesnt_fit_PICO == 1) %>% 
  summarise(Why_rejected="TOP Roses Cat: 779 - Z",num=n_distinct(aid), pct=num/num.rejects*100)

### THIS ONLY GIVES ME 604 Papers!!! WHY??!?!?!? NEED TO Come back to this





# ------TRYING ANOTHER WAY ------------ COME BACK TO THIS
# Reasons for Rejection
## get no. entries
max.rej <- paste0("WhyRej",rep(1:max(str_count(Reject_data$Why_rejected, ";")+1))) 
## now, get why rejected
Why.Rejected <- Reject_data %>% 
  mutate(Why_rejected=gsub(",",";",Why_rejected)) %>%  # replace "," with ";" to help with splitting (had both , and ; as separators)
  group_by(aid,Why_rejected) %>%
  summarise() %>% 
  filter(!is.na(Why_rejected)) %>% 
  separate(Why_rejected,max.rej, sep="; ",fill="right") %>% # fill=right fills blanks with NAs
  gather("X","WhyRej", max.rej) %>%   #gather is a tidyr function that reshapes columns into key pairs 
  filter(!is.na(WhyRej)) %>% #weirdly doesn't remove aid 705
  select(-X) %>% 
  group_by(WhyRej) %>%
  select(aid, WhyRej) %>% 
  count(WhyRej) %>%     #count creates an "n" column
  mutate(group.pct=n/num.studies*100) %>%   #this creates the "pct" column
  arrange(desc(n)) %>% 
  print()
# ------TRYING ANOTHER WAY ------------ COME BACK TO THIS





# Now, let's Dive into the "Doesn't Fit PICO" section:

## Population
Reject_data %>%
  filter(Population==1) %>% 
  summarise(PICO_details="Population", num=n_distinct(aid), pct=num/num.rejects*100)
## Intervention
Reject_data %>%
  filter(Intervention==1) %>% 
  summarise(PICO_details="Intervention", num=n_distinct(aid), pct=num/num.rejects*100) 
## Outcome
Reject_data %>%
  filter(Outcome==1) %>% 
  summarise(PICO_details="Outcome", num=n_distinct(aid), pct=num/num.rejects*100)
## Theoretical_Modeled_Study
Reject_data %>%
  filter(Theoretical_Modeled_Study==1) %>% 
  summarise(PICO_details="Theoretical or Modeled_Study", num=n_distinct(aid), pct=num/num.rejects*100) 
## Not_Peer_Reviewed
Reject_data %>%
  filter(Not_Peer_Reviewed==1) %>% 
  summarise(PICO_details="Not Peer Reviewed", num=n_distinct(aid), pct=num/num.rejects*100) 

#Total Accepted Full-Text studies
print(num.studies)
```


# Studies Over Time Stats!

```{r eval=T}
# STATS - growth by decade

##late 1990s Count - starts in 1994 bc this is the first year, <1995
(max(All_time_gps$val[All_time_gps$Year.of.publication<2000])-max(All_time_gps$val[All_time_gps$Year.of.publication<1995]))/5
##late 1990s PERCENT - starts in 1994 bc this is the first year
(max(All_time_gps$val[All_time_gps$Year.of.publication<2000])-max(All_time_gps$val[All_time_gps$Year.of.publication<1995]))/5/num.studies*100

##2000-2010 Count
(max(All_time_gps$val[All_time_gps$Year.of.publication<2010])-max(All_time_gps$val[All_time_gps$Year.of.publication<2000]))/10
##2000-2010 PERCENT
(max(All_time_gps$val[All_time_gps$Year.of.publication<2010])-max(All_time_gps$val[All_time_gps$Year.of.publication<2000]))/10/num.studies*100

##2010-2019 Count (should be 2018 - 1 paper was just categorized as 2019 instead...)
(max(All_time_gps$val[All_time_gps$Year.of.publication<2019])-max(All_time_gps$val[All_time_gps$Year.of.publication<2010]))/9
##2010-2019 PERCENT (should be 2018 - 1 paper was just categorized as 2019 instead...)
(max(All_time_gps$val[All_time_gps$Year.of.publication<2019])-max(All_time_gps$val[All_time_gps$Year.of.publication<2010]))/9/num.studies*100

##Last 3 years of study STATS
(171-129)/num.studies*100
```

2. P: Geographies

Geographical scale of intervention is used

```{r eval=T}
# P: Geographies (aka intervention location)
##use data from world map I created!

#GET COUNTRY DATA
print(ctry_sum.5, n=90)

# GET REGION AND SUBREGION DATA
# Join the Dataframe to rnaturalearth ne_countries (world_countries) 
region <- ctry_sum %>% 
  full_join(world_countries,by="admin") %>%  # full_join keeps all ROWS (even the n=0 rows!) - need country CODES
  filter(!is.na(aid)) %>%
  select(aid, admin, adm0_a3, sovereignt, type, economy)
# join region with the regions and continents in the old "country" dataset (again, full_join)
region2 <- region %>% 
  left_join(country, by = c("adm0_a3" = "code")) %>% #left join only joins countries/territories represented in region dataset!
  select(-Country) %>%
  ungroup() #need to ungroup, because in this datafile things are still GROUPED by "admin", but I want to take OUT admin!
    #class(region2) - tip, use this if I'm having issues with the dataframe to try and understand it

# sort Subregions of represented papers!
subregion_dat <- region2 %>% 
  select(aid,Region,Subregion) %>% #didn't have this before, this is why my stats were OFF
  group_by(aid) %>%     #didn't have this before, this is why my stats were OFF
  distinct(Subregion) %>%  #didn't have this before, this is why my stats were OFF
  ungroup() %>%
  count(Subregion)%>%     #count creates an "n" column
  mutate(subregion.pct=n/num.studies*100) %>%   #this creates the "pct" column
  arrange(desc(n)) %>% 
  print()

# sort Regions of represented papers!
region_dat <- region2 %>% 
  select(aid,Region,Subregion) %>% #didn't have this before, this is why my stats were OFF
  group_by(aid) %>%     #didn't have this before, this is why my stats were OFF
  distinct(Region) %>%  #didn't have this before, this is why my stats were OFF
  ungroup() %>%
  count(Region)%>%     #count creates an "n" column
  mutate(Region.pct=n/num.studies*100) %>%   #this creates the "pct" column
  arrange(desc(n)) %>% 
  print()

# HOW MANY STUDIES have more than one country/territory
num_countries <- ctry_sum %>% 
  select(-aid) %>% 
  group_by(X) %>% 
  count() %>%     #count creates an "n" column
  mutate(pct=n/num.studies*100) %>%   #this creates the "pct" column
  arrange(desc(n)) %>% 
  print()
    # NOTE HERE: DISPLAYING HIGHER stats (e.g. 7+ countries) may not be right, bc of double-counting (e.g. France), so keep it to lower (e.g. 3+)
#WHICH studies do NOT have countries and territories listed? Should be 2 (bc ^, pct of ctry1 = 98.8, n=169 (not 171))
  #394 is one of them... it actually has 6 studies, but in numbers 2-7 bc spot 1 was a ;
  # other is just aid 705, countries were blank (authors did not know)
```

3. P: Habitats

```{r eval=T}
# Coral
data_all2 %>%
  filter(coral==1) %>% 
  summarise(habitat="Coral", num=n_distinct(aid), pct=num/num.studies*100)

# Seagrass
data_all2 %>%
  filter (seagrass==1) %>% 
  summarise(habitat="Seagrass", num=n_distinct(aid), pct=num/num.studies*100) 

# Mangrove
data_all2 %>%
  filter (mangrove==1) %>% 
  summarise(habitat="Mangrove", num=n_distinct(aid), pct=num/num.studies*100) 

# Note: these DO contain overlap, ie. some studies have multiple habitats:

# How many studies took place in only one of three habitats?
data_all2 %>% 
  filter(coral + seagrass + mangrove == 1) %>% 
  summarise(habitat="Only One",num=n_distinct(aid), pct=num/num.studies*100)

# How many studies took place in multiple habitats? (2 or more)
data_all2 %>% 
  filter(coral + seagrass + mangrove >= 2) %>% 
  summarise(habitat="Multiple: 2 or more!", num=n_distinct(aid), pct=num/num.studies*100)

# How many studies took place in all 3 habitats?
data_all2 %>% 
  filter(coral + seagrass + mangrove == 3) %>% 
  summarise(habitat="All 3 Habitats!", num=n_distinct(aid), pct=num/num.studies*100)
  
```

5. C: Comparators, Study designs used aka MANY Stats here!

```{r eval=T}

# Primary vs Secondary Data (Mutually Exclusive)
data_all2 %>%
  group_by(Primary.or.secondary.data.) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # this arranges them in descending order 

# Type of Data (Mutually Exclusive)
data_all2 %>%
  group_by(What.type.of.data.does.this.study.consider.) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # this arranges them in descending order 

# Comparator Type
## get no. articles per comparator
max.comp <- paste0("comp",rep(1:max(str_count(data_all2$Comparator.type, ";")+1))) 

## now, get comparator types
comparator.types <- data_all2 %>% 
  group_by(aid,Comparator.type) %>%
  summarise() %>% 
  filter(!is.na(Comparator.type)) %>% 
  separate(Comparator.type,max.comp, sep=", ",fill="right") %>% # fill=right fills blanks with NAs
  gather("X","comparator", max.comp) %>%   #gather is a tidyr function that reshapes columns into key pairs 
  filter(!is.na(comparator)) %>% #weirdly doesn't remove aid 705
  select(-X) %>% 
  group_by(comparator) %>%
  select(aid, comparator) %>% 
  count(comparator) %>%     #count creates an "n" column
  mutate(comp.pct=n/num.studies*100) %>%   #this creates the "pct" column
  arrange(desc(n)) %>% 
  print()

## Find and look at the 5 "None" comparator studies
unique(data_all2 %>% 
  filter(Comparator.type== "None") %>% 
  select(aid))

# Does the Study population considers human groups? (mutually exclusive)
data_all2 %>%
  group_by(Does.the.study.explicitly.examine.impacts.on.different.human.groups.) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # this arranges them in descending order 

# If so, what types of human groups? - NEED TO get all groups!# Comparator Type
## get no. articles per
max.groups <- paste0("comp",rep(1:max(str_count(data_all2$If.so..what.types.of.different.groups., ";")+1))) 

## now, get human groups
human.groups <- data_all2 %>% 
  group_by(aid,If.so..what.types.of.different.groups.) %>%
  summarise() %>% 
  filter(!is.na(If.so..what.types.of.different.groups.)) %>% 
  separate(If.so..what.types.of.different.groups.,max.groups, sep=", ",fill="right") %>% # fill=right fills blanks with NAs
  gather("X","human.groups", max.groups) %>%   #gather is a tidyr function that reshapes columns into key pairs 
  filter(!is.na(human.groups)) %>% #weirdly doesn't remove aid 705
  select(-X) %>% 
  group_by(human.groups) %>%
  select(aid, human.groups) %>% 
  count(human.groups) %>%     #count creates an "n" column
  mutate(group.pct=n/num.studies*100) %>%   #this creates the "pct" column
  arrange(desc(n)) %>% 
  print()

# Scale of Study - as related to the INTERVENTION (mutually exclusive)
data_all2 %>%
  group_by(Scale.of.study) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # this arranges them in descending order 
```

# Looking at Fisheries Papers (as deemed by screeners!)

```{r eval=T}
# Looking at Fisheries Papers (as deemed by screeners) - mutually exclusive
Fisheries_Papers <- data_all2 %>%
  filter(Fisheries.Paper. == "Yes")
  # View() # spot check
  # write.csv(Fisheries_Papers,paste0(tabledir,today.date,"_Fisheries_Papers.csv"))

## How many studies are Fisheries Papers?
n_distinct(data_all2$aid[data_all2$Fisheries.Paper. == "Yes"])
```

4. I: Interventions

```{r eval=T}
# I: Interventions
data_all2 %>%
  group_by(Int_cat) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # arranges them in descending order 

  # Highest: % - top 3 (tie for second highest)
data_all2 %>%  
  filter(Int_cat== "1. Land/Water Management"| 
           Int_cat== "2. Species Management"| 
           Int_cat== "7. Legal & Policy Frameworks") %>%  
  summarise(intervention="Highest 3", num=n_distinct(aid), pct=num/num.studies*100)

  # Lowest: % - bottom 3 (tie for lowest)
data_all2 %>%  
  filter(Int_cat== "3. Awareness Raising "| 
           Int_cat== "4. Enforcement & Protection"| 
           Int_cat== "8. Education & Training") %>%  
  summarise(intervention="Lowest 3", num=n_distinct(aid), pct=num/num.studies*100)

  # Subcategories (want % of each):
data_all2 %>%
  group_by(Intervention.subcategory) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # arranges them in descending order 
  # arrange (num) # arranges in ascending order, swap
```

# Multiple Intervention Studies

In the paper, I look at rate of integrated (multiple) intervention studies over time... I just did this by hand based on the multi_int_time_gps table created in this script

```{r eval=T}
#get multi-intervention studies
multi.int.studies <- data_all2 %>% 
    group_by(aid) %>% 
    summarise(n.int=n_distinct(Int_cat)) %>% 
   filter(n.int>1)

#Distinct NUMBER of Multiple Intervention Studies!
n_distinct(multi.int.studies$aid)
#Distinct PERCENT of Multiple Intervention Studies!
n_distinct(multi.int.studies$aid)/num.studies*100

multi.int.aid <- multi.int.studies$aid[multi.int.studies$n.int>1]

Multi_int_time_gps <- data_all2 %>%
  filter(aid%in%multi.int.aid) %>% 
  group_by(Year.of.publication) %>% 
  summarise(pub.per.yr= n_distinct(aid)) %>% 
  ungroup() %>% 
  arrange(Year.of.publication) %>% 
  mutate(val=cumsum(pub.per.yr),
         gp="Multi-intervention") %>% 
  select(Year.of.publication,gp,pub.per.yr,val) %>% 
  filter(!is.na(Year.of.publication))
# View(Multi_int_time_gps)

# STATS - growth over time

##2005-2010 Count
(max(Multi_int_time_gps$val[Multi_int_time_gps$Year.of.publication<2010])-max(Multi_int_time_gps$val[Multi_int_time_gps$Year.of.publication<2005]))/5
##2005-2010 PERCENT
(max(Multi_int_time_gps$val[Multi_int_time_gps$Year.of.publication<2010])-max(Multi_int_time_gps$val[Multi_int_time_gps$Year.of.publication<2005]))/5/num.studies*100

##2010-2018 Count
(max(Multi_int_time_gps$val[Multi_int_time_gps$Year.of.publication<2019])-max(Multi_int_time_gps$val[Multi_int_time_gps$Year.of.publication<2010]))/9
##2010-2018 PERCENT
(max(Multi_int_time_gps$val[Multi_int_time_gps$Year.of.publication<2019])-max(Multi_int_time_gps$val[Multi_int_time_gps$Year.of.publication<2010]))/9/num.studies*100


# WHICH Interventions were used the most in Multi-int studies?!
Multi_int_data <- data_all2 %>%
  filter(aid%in%multi.int.aid) %>% 
  distinct(Int_cat) %>%
  ungroup() %>%
  count(Int_cat)%>%     #count creates an "n" column
    # mutate(pct=n/num.studies*100) %>%   #"pct" column - do we want it out of TOTAL studies? Not right now
  mutate(pct.multi_int=n/n_distinct(multi.int.studies$aid)*100) %>%   #"pct" column - out of MULTI-INT Studies - 62 studies!
  arrange(desc(n)) %>% 
  print()

# WHICH SUB - Interventions were used the most in Multi-int studies?!
Multi_subint_data <- data_all2 %>%
  filter(aid%in%multi.int.aid) %>% 
  distinct(Intervention.subcategory) %>%
  ungroup() %>%
  count(Intervention.subcategory)%>%     #count creates an "n" column
    # mutate(pct=n/num.studies*100) %>%   #"pct" column - do we want it out of TOTAL studies? Not right now
  mutate(pct.multi_int=n/n_distinct(multi.int.studies$aid)*100) %>%   #"pct" column - out of MULTI-INT Studies - 62 studies!
  arrange(desc(n)) %>% 
  print()
  
```

# Intervention and Outcome Pairs
AND sub.int and sub.out!

```{r eval=T}
#Intervention and Outcome Pairs, with # of papers and %s
#view(io_counts.all)
head(io_counts.all)
tail(io_counts.all)

# Sub-Interventions and Sub-Outcomes
#view(io_counts.subintout)
head(io_counts.subintout)
tail(io_counts.subintout)
```

6. O: Outcomes:

```{r eval=T}
data_all2 %>%
  group_by(Outcome_cat) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)%>% 
  arrange (desc(num))  # this arranges them in descending order 

# % Pop/Species and Ecological Community combined (no overlaps):
data_all2 %>%  
  filter(Outcome_cat== "1. Population/Species"| 
         Outcome_cat==  "2. Ecological Community") %>%  
  summarise(num=n_distinct(aid), pct=num/num.studies*100)

  # % in social: human well-being, knowledge and behavior, and governance
data_all2 %>%  
  filter(Outcome_cat== "5. Human Wellbeing"| 
          Outcome_cat== "6. Knowledge and Behavior"| 
          Outcome_cat== "7. Governance") %>%  
  summarise(num=n_distinct(aid), pct=num/num.studies*100)

  # % in ecosystem function and ecosystem service
data_all2 %>%  
  filter(Outcome_cat== "3. Ecosystem Function"| 
          Outcome_cat==  "4. Ecosystem Services") %>%  
  summarise(num=n_distinct(aid), pct=num/num.studies*100)

  # Subcategories (want % of each):
data_all2 %>% 
  group_by(Outcome.subcategory) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100) %>%
  arrange (desc(num))  # this arranges them in descending order 
  # arrange (num) # for ascending order, swap
  
```


#INTERDISCIPLINARY OUTCOME PAPERS!!!
#THE SCRIPT BELOW CONTAINS INTERDISC OUTCOME PAPER SCRIPT, and has NOT been run through/edited!!! (e.g. for percentages, tweaks in figures, etc.)



# Interdisciplinary Outcomes

# Add eco vs soc outcome counts
```{r eval=T}
unique(data_all2$Outcome_cat)
eco.outcomes <- c("2. Ecological Community", "1. Population/Species", "3. Ecosystem Function")
soc.outcomes <- c("6. Knowledge and Behavior", "5. Human Wellbeing", "7. Governance")
        
data_all2 <- data_all2 %>%
  # select(aid, Outcome_cat) %>%
  mutate(eco.out=ifelse(Outcome_cat%in%eco.outcomes,1,0),
         soc.out=ifelse(Outcome_cat%in%soc.outcomes,1,0),
         es.out=ifelse(Outcome_cat=="4. Ecosystem Services",1,0)) %>% 
  group_by(aid) %>% 
  mutate(eco.aid=max(eco.out),
            soc.aid=max(soc.out),
            es.aid=max(es.out),
            eco.soc.aid=ifelse(eco.aid+soc.aid>1,1,0),
            es.eco.soc.aid=ifelse(eco.aid+es.aid>1 | soc.aid+es.aid>1,1,0),
            interdisc.aid=ifelse(eco.soc.aid==1 | es.eco.soc.aid==1,1,0)) 

# View(select(data_all2,Outcome_cat,eco.aid:interdisc.aid)) # spot check

# Which studies have both Ecological and Social outcomes? (No ecosystem services)
n_distinct(data_all2$aid[data_all2$eco.soc.aid == 1])

# Which studies have both Ecological and Social outcomes? (includes ecosystem services)
n_distinct(data_all2$aid[data_all2$interdisc.aid == 1])

# Eco_Soc_ES_Out and export csv
Eco_Soc_ES_Out <- data_all2 %>%
  filter(interdisc.aid == 1)
# View(select(Eco_Soc_ES_Out,Outcome_cat,eco.aid:interdisc.aid)) # spot check
write.csv(Eco_Soc_ES_Out,paste0(tabledir,today.date,"_Eco_and_Soc_and_ES_Outcomes.csv"))
```

## Interdisciplinary outcome comparison heat maps
```{r eval=T}

interd.dat <- data_all2 %>% 
  mutate(typ=case_when(
  soc.aid == 1 & interdisc.aid == 0 ~ "social only",
  eco.aid == 1 & interdisc.aid == 0 ~ "eco only",
  interdisc.aid == 1 ~ "interdisciplinary"),
  typ=as.factor(typ))

interd.out <- interd.dat %>% 
  group_by(Outcome_cat,typ) %>% 
  count() %>% 
  group_by(Outcome_cat) %>% 
  mutate(prop=n/sum(n)) %>% 
  filter(!is.na(typ))

interd.int <- interd.dat %>% 
  group_by(Int_cat,typ) %>% 
  count() %>% 
  group_by(Int_cat) %>% 
  mutate(prop=n/sum(n))%>% 
  filter(!is.na(typ))

plot_grid(
# ggplot(interd.out, aes(fill=typ, y=prop, x=Outcome_cat)) + 
#     geom_bar(position="stack", stat="identity") +
#     coord_flip(), 
# ggplot(interd.out, aes(fill=typ, y=n, x=Outcome_cat)) + 
#     geom_bar(position="stack", stat="identity") +
#     coord_flip(),
ggplot(interd.int, aes(fill=typ, y=prop, x=Int_cat)) + 
    geom_bar(position="stack", stat="identity") +
    coord_flip(),
ggplot(interd.int, aes(fill=typ, y=n, x=Int_cat)) + 
    geom_bar(position="stack", stat="identity") +
    coord_flip(),
 nrow=2)

Eco_Soc_ES_Out <- data_all2 %>%
  filter(interdisc.aid == 1)

# All ecosystems all  vs interdisc. studies
my_heat_map(Eco_Soc_ES_Out,"Int_cat","Outcome_cat")
(heat.map.all.itd <- heat.map +
    labs(x="Conservation Intervention", y="Outcome", title ="All ecosystems"))
plot_grid(heat.map.all + labs(title= "all studies"),
          heat.map.all.itd + labs(title= "interdisciplinary studies"))
ggsave(paste0(plotdir,today.date,'_interdisc_int_out_map.png'),width = 16,height = 8)

# Coral
my_heat_map(filter(data_all2,coral==1),"Int_cat","Outcome_cat", high.col = "coral3")
io_counts.coral <- io_counts
(heat.map.coral <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Coral"))

# Mangrove
my_heat_map(filter(data_all2,mangrove==1),"Int_cat","Outcome_cat", high.col = "orange2")
io_counts.mangrove <- io_counts
(heat.map.mangrove <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Mangrove")) 

# Seagrass
my_heat_map(filter(data_all2,seagrass==1),"Int_cat","Outcome_cat", high.col = "green4")
io_counts.seagrass <- io_counts
(heat.map.seagrass <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Seagrass")) 

# Ecosystem maps on same scale
max.val <- max(io_counts.mangrove$n,io_counts.coral$n,io_counts.seagrass$n)
p.ecosystem.all <- plot_grid(heat.map.coral + scale_fill_gradient2(low="#f7fbff",high= "coral3",name="# Cases",na.value="black", limits=c(0,max.val)),
          heat.map.seagrass + scale_fill_gradient2(low="#f7fbff",high= "green4",name="# Cases",na.value="black", limits=c(0,max.val)),
          heat.map.mangrove + scale_fill_gradient2(low="#f7fbff",high= "orange2",name="# Cases",na.value="black", limits=c(0,max.val)),
          labels=letters[1:3], ncol = 3, nrow = 1, hjust=-1, align = "hv")

# Coral
my_heat_map(filter(Eco_Soc_ES_Out,coral==1),"Int_cat","Outcome_cat", high.col = "coral3")
io_counts.coral.itdc <- io_counts
(heat.map.coral.itdc <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Coral"))

# Mangrove
my_heat_map(filter(Eco_Soc_ES_Out,mangrove==1),"Int_cat","Outcome_cat", high.col = "orange2")
io_counts.mangrove.itdc <- io_counts
(heat.map.mangrove.itdc <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Mangrove")) 

# Seagrass
my_heat_map(filter(Eco_Soc_ES_Out,seagrass==1),"Int_cat","Outcome_cat", high.col = "green4")
io_counts.seagrass.itdc <- io_counts
(heat.map.seagrass.itdc <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Seagrass")) 

# Ecosystem maps on same scale
max.val <- max(io_counts.mangrove.itdc$n,io_counts.coral.itdc$n,io_counts.seagrass.itdc$n)
p.ecosystem.all.itdc <- plot_grid(heat.map.coral.itdc + scale_fill_gradient2(low="#f7fbff",high= "coral3",name="# Cases",na.value="black", limits=c(0,max.val)),
          heat.map.seagrass.itdc + scale_fill_gradient2(low="#f7fbff",high= "green4",name="# Cases",na.value="black", limits=c(0,max.val)),
          heat.map.mangrove.itdc + scale_fill_gradient2(low="#f7fbff",high= "orange2",name="# Cases",na.value="black", limits=c(0,max.val)),
          labels=letters[1:3], ncol = 3, nrow = 1, hjust=-1, align = "hv")

plot_grid(p.ecosystem.all,p.ecosystem.all.itdc,nrow=2)
ggsave(paste0(plotdir,today.date,'_interdisc_habitat_int_out_map.png'),width = 17,height = 16)
```

## Multi-intervention & Interdisciplinary outcome sub heat maps
```{r eval=T}

#  Interventions
int.x.count <- data_all2 %>% 
  select(aid, Int_cat) %>% 
  filter(Int_cat!="" & !is.na(Int_cat)) %>%  # just in case
  arrange(aid,Int_cat) %>% 
  distinct() %>%
  group_by(aid) %>%
  filter(n() > 1) %>%
  split(.$aid) %>%
  map(., 2) %>%
  map(~combn(.x, m = 2)) %>%
  map(~t(.x)) %>%
  map_dfr(as_tibble) %>% 
  group_by(V1,V2) %>% 
  count() %>% 
  rename(Int1=V1,Int2=V2)
  
  int.x.list <- expand.grid(int_list$int_val,int_list$int_val)  %>% 
    rename(Int1=Var1,Int2=Var2)

  int.x.count.full <- int.x.count %>% 
    full_join(int.x.list) %>%   # inserts missing combinations
  #  mutate(n=replace_na(n,0)) %>%
    ungroup() %>% 
    mutate( Int1=factor( Int1,levels=mixedsort(int_list$int_val))  # set int list in right order
 )

ggplot(data=int.x.count.full, aes(x=Int2,y=reorder(Int1, desc(Int1)))) +
    theme_bw() +
    geom_tile(aes(fill = n), color='white',size=0.1) +
    scale_fill_gradient(low = '#f7fbff', high = '#2171b5', space = 'Lab',na.value="white",limits=c(0,max(int.x.count.full$n))) +
    geom_text(aes(label=n),show.legend = T) +
    theme(axis.text.x=element_text(angle=90),
          axis.ticks=element_blank(),
          axis.line=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_line(color='#eeeeee'))+
    theme(axis.text.x = element_text(angle=45,hjust=0,vjust=1,size=9)) +
    scale_x_discrete(position = "top") +
    scale_y_discrete(position = "right") +
    labs(x="Intervention 1", y="Intervention 2")
  ggsave(paste0(plotdir,today.date,'_multiple_int_map.png'),width = 8,height = 8)
  
  
# Sub-interventions
sub.int.x.count <- data_all2 %>% 
    select(aid, Intervention.subcategory) %>% 
    filter(Intervention.subcategory!="" & !is.na(Intervention.subcategory)) %>%  # just in case
    arrange(aid,Intervention.subcategory) %>% 
    distinct() %>%
    group_by(aid) %>%
    filter(n() > 1) %>%
    split(.$aid) %>%
    map(., 2) %>%
    map(~combn(.x, m = 2)) %>%
    map(~t(.x)) %>%
    map_dfr(as_tibble) %>% 
    group_by(V1,V2) %>% 
    count() %>% 
    rename(Int1=V1,Int2=V2)
  
sub.int.x.list <- expand.grid(int_sub_list$int_val,int_sub_list$int_val)  %>% 
    rename(Int1=Var1,Int2=Var2)
  
sub.int.x.count.full <- sub.int.x.count %>% 
    full_join(sub.int.x.list) %>%   # inserts missing combinations
   # mutate(n=replace_na(n,0)) %>%
    ungroup() %>% 
    mutate( Int1=factor( Int1,levels=mixedsort(int_sub_list$int_val))  # set int list in right order
    )
  
ggplot(data=sub.int.x.count.full, aes(x=Int2,y=reorder(Int1, desc(Int1)),fill=n)) +
  theme_bw() +
  geom_tile(aes(fill = n), color='white',size=0.1) +
  scale_fill_gradient(low = '#f7fbff', high = '#2171b5', space = 'Lab',na.value="white",limits=c(0,max(sub.int.x.count.full$n))) +
  geom_text(aes(label=n),show.legend = T) +
  theme(axis.text.x=element_text(angle=90),
        axis.ticks=element_blank(),
        axis.line=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_line(color='#eeeeee'))+
  theme(axis.text.x = element_text(angle=45,hjust=0,vjust=1,size=9)) +
  scale_x_discrete(position = "top") +
  scale_y_discrete(position = "right") +
  labs(x="Sub-Intervention 1", y="Sub-Intervention 2")
ggsave(paste0(plotdir,today.date,'_multiple_sub_int_map.png'),width = 12,height = 12)
  
  
# Outcomes
out.x.count <- data_all2 %>% 
    select(aid, Outcome_cat) %>% 
    filter(Outcome_cat!="" & !is.na(Outcome_cat)) %>%  # just in case
    arrange(aid,Outcome_cat) %>% 
    distinct() %>%
    group_by(aid) %>%
    filter(n() > 1) %>%
    split(.$aid) %>%
    map(., 2) %>%
    map(~combn(.x, m = 2)) %>%
    map(~t(.x)) %>%
    map_dfr(as_tibble) %>% 
    group_by(V1,V2) %>% 
    count() %>% 
    rename(Out1=V1,Out2=V2)
  
  out.x.list <- expand.grid(out_list$out_val,out_list$out_val)  %>% 
    rename(Out1=Var1,Out2=Var2)
  
  out.x.count.full <- out.x.count %>% 
    full_join(out.x.list) %>%   # inserts missing combinations
  #  mutate(n=replace_na(n,0)) %>%
    ungroup() %>% 
    mutate(Out1=factor(Out1,levels=mixedsort(out_list$out_val))  # set Out list in right order
    )
  ggplot(data=out.x.count.full, aes(x=Out2,y=reorder(Out1, desc(Out1)),fill=n)) +
    theme_bw() +
    geom_tile(aes(fill = n), color='white',size=0.1) +
    scale_fill_gradient(low = '#f7fbff', high = '#2171b5', space = 'Lab',na.value="white",limits=c(0,max(sub.int.x.count.full$n))) +
    geom_text(aes(label=n),show.legend = T) +
    theme(axis.text.x=element_text(angle=90),
          axis.ticks=element_blank(),
          axis.line=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_line(color='#eeeeee'))+
    theme(axis.text.x = element_text(angle=45,hjust=0,vjust=1,size=9)) +
    scale_x_discrete(position = "top") +
    scale_y_discrete(position = "right") +
    labs(x="Outcome 1", y="Outcome 2")
  
ggsave(paste0(plotdir,today.date,'_multiple_out_map.png'),width = 8,height = 8)
  
  # sub-outcomes
sub.out.x.count <- data_all2 %>% 
    select(aid, Outcome.subcategory) %>% 
    filter(Outcome.subcategory!="" & !is.na(Outcome.subcategory)) %>%  # just in case
    arrange(aid,Outcome.subcategory) %>% 
    distinct() %>%
    group_by(aid) %>%
    filter(n() > 1) %>%
    split(.$aid) %>%
    map(., 2) %>%
    map(~combn(.x, m = 2)) %>%
    map(~t(.x)) %>%
    map_dfr(as_tibble) %>% 
    group_by(V1,V2) %>% 
    count() %>% 
    rename(Out1=V1,Out2=V2)
  
sub.out.x.list <- expand.grid(out_sub_list$out_val,out_sub_list$out_val)  %>% 
    rename(Out1=Var1,Out2=Var2)
  
sub.out.x.count.full <- sub.out.x.count %>% 
    full_join(sub.out.x.list) %>%   # inserts missing combinations
  #  mutate(n=replace_na(n,0)) %>%
    ungroup() %>% 
    mutate(Out1=factor(Out1,levels=mixedsort(out_sub_list$out_val))  # set Out list in right order
    )

ggplot(data=sub.out.x.count.full, aes(x=Out2,y=reorder(Out1, desc(Out1)),fill=n)) +
    theme_bw() +
    geom_tile(aes(fill = n), color='white',size=0.1) +
    scale_fill_gradient(low = '#f7fbff', high = '#2171b5', space = 'Lab',na.value="white",limits=c(0,max(sub.int.x.count.full$n))) +
    geom_text(aes(label=n),show.legend = T) +
    theme(axis.text.x=element_text(angle=90),
          axis.ticks=element_blank(),
          axis.line=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_line(color='#eeeeee'))+
    theme(axis.text.x = element_text(angle=45,hjust=0,vjust=1,size=9)) +
    scale_x_discrete(position = "top") +
    scale_y_discrete(position = "right") +
    labs(x="Outcome 1", y="Outcome 2") 
  
ggsave(paste0(plotdir,today.date,'_multiple_out_map.png'),width = 18,height = 18)
  
# Interdisciplinary sub outcomes
sub.out.x.count.intdisc <- sub.out.x.count.full %>% 
  filter(str_detect(Out1, "^[1234]") & str_detect(Out2, "^[4567]") )
unique(sub.out.x.count.intdisc$Out1)
unique(sub.out.x.count.intdisc$Out2)

ggplot(data=sub.out.x.count.intdisc, aes(x=Out1,y=reorder(Out2, desc(Out2)),fill=n)) +
    theme_bw() +
    geom_tile(aes(fill = n), color='white',size=0.1) +
    scale_fill_gradient(low = '#f7fbff', high = '#2171b5', space = 'Lab',na.value="white",limits=c(0,max(sub.int.x.count.full$n))) +
    geom_text(aes(label=n),show.legend = T) +
    theme(axis.text.x=element_text(angle=90),
          axis.ticks=element_blank(),
          axis.line=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_line(color='#eeeeee'))+
    theme(axis.text.x = element_text(angle=45,hjust=0,vjust=1,size=9)) +
    scale_x_discrete(position = "top") +
    scale_y_discrete(position = "right") +
    labs(x="Ecological + Ecosystem services", y= "Social + Ecosystem services")
  
ggsave(paste0(plotdir,today.date,'interdisc_multiple_out_map.png'),width = 11,height = 8)

# Multi-intervention interdiscpl-outcomes
# id multi-intervention studies
mi.aid <- data_all2 %>%
  group_by(aid,Int_cat) %>% 
  summarise %>% 
  group_by(aid) %>% 
  filter(n()>1) %>% 
  distinct(aid) %>% 
  pull(aid)

mi.sub.out.x.count <- data_all2 %>% 
  filter(aid%in%mi.aid) %>% 
    select(aid, Outcome.subcategory) %>% 
    filter(Outcome.subcategory!="" & !is.na(Outcome.subcategory)) %>%  # just in case
    arrange(aid,Outcome.subcategory) %>% 
    distinct() %>%
    group_by(aid) %>%
    filter(n() > 1) %>%
    split(.$aid) %>%
    map(., 2) %>%
    map(~combn(.x, m = 2)) %>%
    map(~t(.x)) %>%
    map_dfr(as_tibble) %>% 
    group_by(V1,V2) %>% 
    count() %>% 
    rename(Out1=V1,Out2=V2)
  
mi.sub.out.x.list <- expand.grid(out_sub_list$out_val,out_sub_list$out_val)  %>% 
    rename(Out1=Var1,Out2=Var2)
  
mi.sub.out.x.count.interdisc <- sub.out.x.count %>% 
    full_join(sub.out.x.list) %>%   # inserts missing combinations
  #  mutate(n=replace_na(n,0)) %>%
    ungroup() %>% 
    mutate(Out1=factor(Out1,levels=mixedsort(out_sub_list$out_val))  # set Out list in right order
    ) %>% 
    filter(str_detect(Out1, "^[1234]") & str_detect(Out2, "^[4567]") ) # interdisciplinary only


ggplot(data=mi.sub.out.x.count.interdisc, aes(x=Out2,y=reorder(Out1, desc(Out1)),fill=n)) +
    theme_bw() +
    geom_tile(aes(fill = n), color='white',size=0.1) +
    scale_fill_gradient(low = '#f7fbff', high = '#2171b5', space = 'Lab',na.value="white",limits=c(0,max(sub.int.x.count.full$n))) +
    geom_text(aes(label=n),show.legend = T) +
    theme(axis.text.x=element_text(angle=90),
          axis.ticks=element_blank(),
          axis.line=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_line(color='#eeeeee'))+
    theme(axis.text.x = element_text(angle=45,hjust=0,vjust=1,size=9)) +
    scale_x_discrete(position = "top") +
    scale_y_discrete(position = "right") +
    labs(x="Outcome 1", y="Outcome 2") 
  
ggsave(paste0(plotdir,today.date,'_multi-intervention_multiple_out_map.png'),width = 18,height = 18)

#--- Chord diagram
chord.dat <- data_all2 %>% 
  filter(interdisc.aid==1) %>% 
  group_by(Int_cat,Outcome_cat) %>% 
  summarise(value=n_distinct(aid))

# original
pacman::p_load(circlize)
chordDiagram(chord.dat)
circos.clear()

# rotate labels (prob easier to reduce them)
png(paste0(plotdir,today.date,'_multi-intervention_multiple_out_chord.png'), width = 10, height = 8, units = "in", res=600) 
chordDiagram(chord.dat, annotationTrack = "grid", 
    preAllocateTracks = list(track.height = max(strwidth(unlist(dimnames(chord.dat))))))
# we go back to the first track and customize sector labels
circos.track(track.index = 1, panel.fun = function(x, y) {
    circos.text(CELL_META$xcenter, CELL_META$ylim[1], CELL_META$sector.index, 
        facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) 
dev.off()


# rotate labels (prob easier to reduce them)
png(paste0(plotdir,today.date,'_multi-intervention_multiple_out_chord_reverse.png'), width = 10, height = 8, units = "in", res=600) 
chordDiagram(select(chord.dat,Outcome_cat,Int_cat,value), annotationTrack = "grid", 
    preAllocateTracks = list(track.height = max(strwidth(unlist(dimnames(chord.dat))))))
# we go back to the first track and customize sector labels
circos.track(track.index = 1, panel.fun = function(x, y) {
    circos.text(CELL_META$xcenter, CELL_META$ylim[1], CELL_META$sector.index, 
        facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) 
dev.off()
```

7. Time periods

IN PROGRESS

```{r eval=T}

# Extra: Time Period:

  # % of studies after 2000
  # % of studies in the year:....
  # % of studies in [specific intervention area] during [specific time]
  
  # % of studies in top 2 interventions (cons desig and spec management) 
    # during [specific time]
  
  # could do ^ for outcome, could also try to get a chart that gives # of each
    # intervention and outcome for each year. Should be able to do this!

# make barplot
test.dat <- data_all2 %>%
            group_by(Outcome_cat) %>% 
            summarise(num=n_distinct(aid), pct=num/num.studies)
ggplot(test.dates(Outcome_cat,num)) +
  geom_bar(stat = )
