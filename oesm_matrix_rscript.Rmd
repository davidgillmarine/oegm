---
title: "OEGM script"
author: "David A. Gill & Dana I. Grieco"
date: "3/17/2021"
output: html_document
---

# Setup
Loads libraries, reads in data, cleans datasets
```{r eval=T}
#set working directory to the correct folders on your machine
workdir <- "R:/Gill/research/oegm/"
inputdir <- paste0(workdir,"tables/raw/")
mapdir <-  paste0(workdir,"spatial/raw/")
plotdir <- paste0(workdir,"output/plots/")

pacman::p_load(rio,rgeos,treemap,gtools,cowplot,rnaturalearth,rnaturalearthdata,tidyverse)

today.date <- gsub("-","",Sys.Date())

#--- Organize data ----
#read in data, skip first 2 rows
# non.mangrove<-import(paste0(inputdir,"Non-mangrove_FINAL.xlsx"), which="Data Extraction Sheet", skip =2, .name_repair = "universal") %>% 
#   mutate(Date=as.character(Date))
# mangrove<-import(paste0(inputdir,"Mangrove_FINAL.xlsx"), which="Data Extraction Sheet", skip =2,  .name_repair = "universal") %>% 
#   mutate(Date=as.character(Date))

all.data<-import(paste0(inputdir,"20210329_All Data.xlsx"), skip =2, .name_repair = "universal") %>% 
  mutate(Date=as.character(Date))
country <- import(paste0(inputdir,"allcountries.csv"))

# Count total papers in Full Text Screening
length(unique(all.data$Article.ID))

# Select accepted papers, rename variables==
data_all <- all.data %>%  
  filter(Full.text.screening.=="Accept" & !is.na(Intervention.category) & !is.na(Outcome.category)) %>% # is this ok to do? would be there cases where NA is ok?
  rename(Int_cat=Intervention.category,Outcome_cat=Outcome.category, aid=Article.ID, study.ctry=Country.ies..of.study)
length(unique(data_all$aid))

# read in full intervention lists
int_list<-import(paste0(inputdir,"intervention abbreviations.csv"))
out_list<-import(paste0(inputdir,"outcome abbreviations.csv"))
drop.down.lists<-import(paste0(inputdir,"20191022_All Data.xlsx"), which="Dropdowns", skip =1, .name_repair = "universal")

int_sub_list <-  drop.down.lists %>% 
  select(Intervention.subcategory) %>% 
  na.omit() %>% 
  rename(int_sub=Intervention.subcategory)
out_sub_list <-  drop.down.lists %>% 
  select(Outcome.subcategory) %>% 
  na.omit() %>% 
  rename(out_sub=Outcome.subcategory) 
num.studies <- length(unique(data_all$aid))


#--- Clean up data ----
# Something went wrong? shift over rows that were missing a column so the data shifted (aid=772), inspect in original data
data_all[data_all$aid%in%772,32:42] # wrong
data_all[data_all$aid%in%772,32:42]  <- data_all[data_all$aid%in%772,31:41] 
data_all[data_all$aid%in%772,32:42]  # right

# Recodes intervention and outcomes fields to the correct version 
# interventions
for (i in 1:nrow(int_list)){
  num.val=paste0("^",i,"\\. *") # starts with this number
  data_all <- data_all %>% 
    mutate(Int_cat=ifelse(grepl(num.val,Int_cat),grep(num.val,int_list$Int_cat_orig,value = T),Int_cat))
}
# sub-interventions
for (i in 1:nrow(int_sub_list)){
  num.val=paste0("^",gsub("\\.(.*)","",int_sub_list$int_sub[i]))  # starts with this number
  data_all <- data_all %>% 
    mutate(Intervention.subcategory=ifelse(grepl(num.val,Intervention.subcategory),
                                           grep(num.val,int_sub_list$int_sub,value = T),Intervention.subcategory))
}
# Outcomes
for (i in 1:nrow(out_list)){
  num.val=paste0("^",i)
  data_all <- data_all %>% 
    mutate(Outcome_cat=ifelse(grepl(num.val,Outcome_cat),grep(num.val,out_list$Outcome_cat_orig,value = T),Outcome_cat))
}
# Sub-outcomes
for (i in 1:nrow(out_sub_list)){
  num.val=paste0("^",gsub("\\.(.*)","",out_sub_list$out_sub[i]))  # starts with this number
  data_all <- data_all %>% 
    mutate(Outcome.subcategory=ifelse(grepl(num.val,Outcome.subcategory),
                                           grep(num.val,out_sub_list$out_sub,value = T),Outcome.subcategory))
}

#quick checks
unique(data_all$Int_cat)  # 10 interventions
unique(data_all$Outcome_cat) # 7 outcomes
sort(unique(data_all$Intervention.subcategory)) # 36 sub-interventions?
sort(unique(data_all$Outcome.subcategory)) # 41 sub-outcomes?

# those that were not observed
int_list$Int_cat_orig[!int_list$Int_cat_orig%in%data_all$Int_cat] 
int_sub_list$int_sub[!int_sub_list$int_sub%in%data_all$Intervention.subcategory] 
out_list$Outcome_cat_orig[!out_list$Outcome_cat_orig%in%data_all$Outcome_cat] 
out_sub_list$out_sub[!out_sub_list$out_sub%in%data_all$Outcome.subcategory] 

# incorrect values entered (all should be zero)  !Morgan: Intervention.subcategory with an NA
data_all$Int_cat[!data_all$Int_cat%in%int_list$Int_cat_orig] 
data_all$Intervention.subcategory[!data_all$Intervention.subcategory%in%int_sub_list$int_sub] 
data_all$Outcome_cat[!data_all$Outcome_cat%in%out_list$Outcome_cat_orig] 
data_all$Outcome.subcategory[!data_all$Outcome.subcategory%in%out_sub_list$out_sub] 

# Add habitat fields
unique(data_all$Habitat.type) 
data_all <- data_all %>% 
mutate(coral=ifelse(grepl("Coral",Habitat.type,ignore.case = T),1,0),
       seagrass=ifelse(grepl("Seagrass",Habitat.type,ignore.case = T),1,0),
       mangrove=ifelse(grepl("mangrove",Habitat.type,ignore.case = T),1,0),)

  # check habitat coding
unique(data_all$Habitat.type[data_all$coral==1])
unique(data_all$Habitat.type[data_all$seagrass==1])
unique(data_all$Habitat.type[data_all$mangrove==1])

habitat.test <- data_all %>% 
  filter(coral==0 & mangrove==0 & seagrass==0) %>% 
  select(Habitat.type)
unique(habitat.test$Habitat.type) # should just be "other"

# remove research and monitoring, and adjust numbers
data_all <-data_all %>% 
  filter(Int_cat!="8. Research & monitoring")%>% 
  mutate_at(vars(Int_cat,Intervention.subcategory), ~gsub("^9","8",.)) %>% 
  mutate_at(vars(Int_cat,Intervention.subcategory), ~gsub("^10","9",.)) %>% 
  mutate_at(vars(Outcome_cat,Outcome.subcategory), ~gsub("^1","9",.)) %>% 
  mutate_at(vars(Outcome_cat,Outcome.subcategory), ~gsub("^2","1",.)) %>% 
  mutate_at(vars(Outcome_cat,Outcome.subcategory), ~gsub("^3","2",.)) %>% 
  mutate_at(vars(Outcome_cat,Outcome.subcategory), ~gsub("^4","3",.)) %>% 
  mutate_at(vars(Outcome_cat,Outcome.subcategory), ~gsub("^5","4",.)) %>% 
  mutate_at(vars(Outcome_cat,Outcome.subcategory), ~gsub("^6","5",.)) %>% 
  mutate_at(vars(Outcome_cat,Outcome.subcategory), ~gsub("^9","6",.)) 

#new quick checks
unique(data_all$Int_cat)  # 9 interventions
unique(data_all$Outcome_cat) # 7 outcomes
sort(unique(data_all$Intervention.subcategory)) # 34 sub-interventions?
sort(unique(data_all$Outcome.subcategory)) # 41 sub-outcomes?

# # Get full intervention list
  int_list <- data_all %>%
    ungroup() %>%
    distinct(Int_cat) %>%
    rename(int_val=Int_cat) %>% 
    arrange(int_val)
  out_list <- data_all %>%
    ungroup() %>%
    distinct(Outcome_cat) %>%
    rename(out_val=Outcome_cat) %>% 
    arrange(out_val)
# Get full sub-intervention list
  int_sub_list <- data_all %>%
    ungroup() %>%
    distinct(Intervention.subcategory) %>%
    rename(int_val=Intervention.subcategory) %>% 
    arrange(int_val)
  out_sub_list <- data_all %>%
    ungroup() %>%
    distinct(Outcome.subcategory) %>%
    rename(out_val=Outcome.subcategory) %>% 
    arrange(out_val)

```


# Heat map function
Creates a heat map from the OESM accepted articles, based on intervention and outcome categories and subcategories

Under # Create Heatmap, the "geom_text" line adds text (numbers) on each heat map cell. We #ed that line for the first OEGM paper, since it was only a subsample of the literature, and thus numbers themselves could be misleading. Similarly, 

In the future, we should be able to make this heat map interactive with plotly (see https://www.r-graph-gallery.com/79-levelplot-with-ggplot2.html)

```{r eval=T}
#--- Heat map function ----
my_heat_map <- function (.data,intc, outc, high.col="#2171b5") {
  
  
# don't know why... but this works
  .data$intc<- as.vector(.data %>%  pull(intc))
  .data$outc<- as.vector(.data %>%  pull(outc))

# Set full intervention list type  
if(intc=="Int_cat"){int_list_full=int_list}
if(intc=="Intervention.subcategory"){int_list_full=int_sub_list}
if(outc=="Outcome_cat"){out_list_full=out_list}
if(outc=="Outcome.subcategory"){out_list_full=out_sub_list}

# Get unique article ID, int. and out. list (and sum of articles)
  typology_dat <- .data %>% 
    select(aid, intc, outc) %>% 
    filter(intc!="" & !is.na(intc)) %>%  # just in case
    distinct() %>% 
    full_join(int_list_full,by =c("intc"="int_val")) %>% 
    full_join(out_list_full,by =c("outc"="out_val")) %>% 
    group_by(intc) %>% 
    mutate(int_val=paste0(intc)) %>% 
      # mutate(int_val=paste0(intc," (",n_distinct(aid,na.rm = T),")")) %>%  #adds article counts to int names
    group_by(outc) %>% 
    mutate(out_val=paste0(outc)) %>% 
      # mutate(out_val=paste0(outc," (",n_distinct(aid,na.rm = T),")")) %>% #adds article counts to out names
    ungroup() %>% 
    select(-c(intc,outc)) 
  
  # Get expanded intervention-outcome list for this dataset
  int_list <- typology_dat %>%
    ungroup() %>%
    filter(int_val!="NA (0)") %>% 
    distinct(int_val) %>%
    arrange(int_val)
  out_list <- typology_dat %>%
    ungroup() %>%
    distinct(out_val) %>%
    filter(out_val!="NA (0)") %>% 
    arrange(out_val)
  io_list <- expand.grid(int_list$int_val,out_list$out_val) %>% 
    rename(int_val=Var1,out_val=Var2)

#head(io_list)
  
  #gather data and get counts 
  io_counts <<- typology_dat %>%
    group_by(int_val, out_val) %>% 
    count() %>%
    full_join(io_list,by = c("int_val", "out_val")) %>%   # inserts missing combinations
    filter(int_val!="NA (0)" &  out_val!="NA (0)") %>% 
    mutate(n=replace_na(n,0)) %>%
    ungroup() %>% 
    mutate(int_val=factor(int_val,levels=mixedsort(int_list$int_val)))  # set int list in right order
  
  # head(io_counts)
  # nrow(int_list)*nrow(out_list)==nrow(io_counts) # quick check (should be true)
  
# Create Heatmap
  heat.map <<- ggplot(data=io_counts, aes(x=int_val,y=reorder(out_val, desc(out_val)),fill=n)) +
      geom_tile(color="gray90",size=0.1) +
      # geom_text(aes(label=n),show.legend = F) + # adds numbers into cells
    scale_fill_gradient2(low="#f7fbff",high=high.col,name="Number of Studies",
        na.value="black", limits=c(0,max(io_counts$n))) + 
      coord_equal() +
      # theme_tufte(base_family="Helvetica") +	# having issues with font, font colour in windows...
      theme(axis.ticks=element_line(size=0.3),
        axis.text=element_text(size=10),
        axis.text.x = element_text(angle=45,hjust=0,vjust=1),
        axis.text.y = element_text(angle=0,hjust=0,vjust=0),
        legend.title=element_text(size=10),
        legend.title.align=1,
        legend.text=element_text(size=8),
        legend.margin = margin(grid::unit(0,"cm")),
        legend.position ="bottom",
        legend.direction ="horizontal",
        legend.key.size=grid::unit(1, "cm"),
        legend.key.width=grid::unit(1, "cm"),
        plot.background=element_blank(),
        panel.border=element_blank(),
        plot.title=element_text(hjust=0,size=12,face="bold"),
        text=element_text(family="sans")) +  # "serif"=TN Roman, "sans" = Arial
      scale_x_discrete(position = "top") +
      scale_y_discrete(position = "right") 
      #  labs(x="Conservation Intervention", y="Outcome", title ="All ecosystems") +
  
}
```

# Create heat maps 
```{r eval=T}
#--- Create maps ----
# All ecosystems
my_heat_map(data_all,"Int_cat","Outcome_cat")
io_counts.all <- io_counts
(heat.map.all <- heat.map +
    labs(x="Conservation Intervention", y="Outcome", title ="All ecosystems"))
ggsave(paste0(plotdir,today.date,'_int_out_map.png'),width = 8,height = 8)

# All ecosystems - Intervention subcategory X Outcome
my_heat_map(data_all,"Intervention.subcategory", "Outcome_cat")
io_counts.subint <- io_counts
(heat.map.subint <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="All ecosystems"))
ggsave(paste0(plotdir,today.date,'_sub.int_out_map.png'),width = 16,height = 8)

# All ecosystems - Intervention  X Outcome subcategory
my_heat_map(data_all,"Int_cat", "Outcome.subcategory")
io_counts.subint <- io_counts
(heat.map.subint <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="All ecosystems"))
ggsave(paste0(plotdir,today.date,'_int_sub.out_map.png'),width = 8,height = 16)

# All ecosystems - Intervention subcategory X Outcome subcategory
my_heat_map(data_all,"Intervention.subcategory", "Outcome.subcategory")
io_counts.subintout <- io_counts
(heat.map.subint <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="All ecosystems"))
ggsave(paste0(plotdir,today.date,'_sub.int_sub.out_map.png'),width = 16,height = 12)

# Coral
my_heat_map(filter(data_all,coral==1),"Int_cat","Outcome_cat", high.col = "coral3")
io_counts.coral <- io_counts
(heat.map.coral <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Coral"))

# Mangrove
my_heat_map(filter(data_all,mangrove==1),"Int_cat","Outcome_cat", high.col = "orange2")
io_counts.mangrove <- io_counts
(heat.map.mangrove <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Mangrove")) 

# Seagrass
my_heat_map(filter(data_all,seagrass==1),"Int_cat","Outcome_cat", high.col = "green4")
io_counts.seagrass <- io_counts
(heat.map.seagrass <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Seagrass")) 

# Ecosystem maps on same scale
max.val <- max(io_counts.mangrove$n,io_counts.coral$n,io_counts.seagrass$n)
plot_grid(heat.map.coral + scale_fill_gradient2(low="#f7fbff",high= "coral3",name="# Cases",na.value="black", limits=c(0,max.val)),
          heat.map.seagrass + scale_fill_gradient2(low="#f7fbff",high= "green4",name="# Cases",na.value="black", limits=c(0,max.val)),
          heat.map.mangrove + scale_fill_gradient2(low="#f7fbff",high= "orange2",name="# Cases",na.value="black", limits=c(0,max.val)),
          labels=letters[1:3], ncol = 3, nrow = 1, hjust=-1, align = "hv")
ggsave(paste0(plotdir,today.date,'_habitat_int_out_map.png'),width = 17,height = 8)


```

# World map
Creates a world map of all habitats
Note: the read in map section takes about a minute to load!
```{r eval=T}
#---- World map ----

unique(data_all$study.ctry)
# fix data in country column
ctry.fix <- data_all %>%
  mutate(study.ctry=gsub(",",";",study.ctry),  # replace "," with ";" to help with splitting
         study.ctry=gsub("Korea; South","Korea, South",study.ctry),
         study.ctry=gsub("Turks and Caicos","Turks and Caicos Islands",study.ctry),
         study.ctry=gsub(".*Virgin Islands","U.S. Virgin Islands",study.ctry),
         study.ctry=gsub("Tanzania; United Republic Of","Tanzania, United Republic Of",study.ctry),
         study.ctry=gsub("Taiwan; Province Of China","Taiwan, Province Of China",study.ctry)) 

# all habitats
ctry.all <- ctry.fix %>% 
  group_by(aid,study.ctry) %>%
  summarise() %>% 
  filter(!is.na(study.ctry))
head(ctry.all)


# get no. articles per country (and percentage) to create vector of column names for each country by counting the number of ";" 
max.ctry <- paste0("ctry",rep(1:max(str_count(ctry.all$study.ctry, ";")+1))) 

ctry_sum <-ctry.all %>% 
  separate(study.ctry,max.ctry, sep="; ",fill="right") %>% # fill=right fills blanks with NAs
  gather("X","Country", max.ctry) %>% 
  filter(!is.na(Country)) %>% 
  select(-X) %>% 
  group_by(Country) %>% 
  count() %>% 
  mutate(pct=n/num.studies)

arrange(ctry_sum,desc(n))

# Countries that need to be fixed
ctry_sum$Country[!ctry_sum$Country%in%country$Country]
# agrep("Virgin Islands",country$Country, value = T) - search original list

# join to full country list
ctry_sum1 <- country %>% 
  left_join(ctry_sum,by="Country") %>%
  mutate(n=na.replace(n,0)) 

ctry_sum$Country[!ctry_sum$Country%in%ctry_sum1$Country] # any missing?

# read in map
map <- rgdal::readOGR(paste0(mapdir,"TM_WORLD_BORDERS-0.3/TM_WORLD_BORDERS-0.3.shp"))
map <-broom::tidy(map,region="ISO3")
#map@data[map@data$NAME=="Turks and Caicos Islands",]

#plot study map
(study_ctry_map <- ggplot() +
    geom_map(data=ctry_sum1, aes(map_id=code, fill=n),map=map) +
    expand_limits(x=map$long,y=map$lat) +
    theme(
        panel.background = element_rect(fill = "#CCCCCC", colour = "#CCCCCC"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border=element_blank(),
        plot.title=element_text(hjust=0,size=12), # face="bold"
        axis.ticks = element_blank(), 
        axis.text = element_blank(),
        axis.title = element_blank(),
        legend.title=element_text(size=10),
        legend.title.align=1,
        legend.text=element_text(size=8),
        legend.position ="bottom",
        text=element_text(family="sans") # "serif"=TN Roman, "sans" = Arial
        ) +
    scale_fill_gradient2(
        name="Number of Studies",
        low="white",mid="#2171b5",high="#08519c",
        midpoint=max(ctry_sum1$n)/2,limits=c(0,max(ctry_sum1$n))) )
    # labs(title="Study countries")  # if axes: x="X axis label", y="Y axis label"
  ggsave(paste0(plotdir,today.date,'_study_country_map.png'),width = 10,height = 5)
```

# World Map - Coral

```{r eval=T}

# -- coral map
ctry.coral <- ctry.fix %>% 
  filter(coral==1) %>% 
  group_by(aid,study.ctry) %>%
  summarise() %>% 
  filter(!is.na(study.ctry))
head(ctry.coral)

# get no. articles per country (and percentage) to create vector of column names for each country by counting the number of ";" 
max.ctry <- paste0("ctry",rep(1:max(str_count(ctry.coral$study.ctry, ";")+1))) 
num.studies <- length(unique(data_all$aid[data_all$coral==1]))

ctry_sum_coral <-ctry.coral %>% 
  separate(study.ctry,max.ctry, sep="; ",fill="right") %>% # fill=right fills blanks with NAs
  gather("X","Country", max.ctry) %>% 
  filter(!is.na(Country)) %>% 
  select(-X) %>% 
  group_by(Country) %>% 
  count() %>% 
  mutate(pct=n/num.studies)

arrange(ctry_sum_coral,desc(n))

# Countries that need to be fixed
ctry_sum_coral$Country[!ctry_sum_coral$Country%in%country$Country]
# agrep("Virgin Islands",country$Country, value = T) - search original list

# join to full country list
ctry_sum_coral1 <- country %>% 
  left_join(ctry_sum_coral,by="Country") %>%
  mutate(n=na.replace(n,0)) 

ctry_sum_coral$Country[!ctry_sum_coral$Country%in%ctry_sum_coral1$Country] # any missing?

# read in map
map <- rgdal::readOGR(paste0(mapdir,"TM_WORLD_BORDERS-0.3/TM_WORLD_BORDERS-0.3.shp"))
map <-broom::tidy(map,region="ISO3")
#map@data[map@data$NAME=="Turks and Caicos Islands",]

#plot study map
(study_ctry_coral_map <- ggplot() +
    geom_map(data=ctry_sum_coral1, aes(map_id=code, fill=n),map=map) +
    expand_limits(x=map$long,y=map$lat) +
    theme(
        panel.background = element_rect(fill = "#CCCCCC", colour = "#CCCCCC"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border=element_blank(),
        plot.title=element_text(hjust=0,size=12), # face="bold"
        axis.ticks = element_blank(), 
        axis.text = element_blank(),
        axis.title = element_blank(),
        legend.title=element_text(size=10),
        legend.title.align=1,
        legend.text=element_text(size=8),
        legend.position ="bottom",
        text=element_text(family="sans") # "serif"=TN Roman, "sans" = Arial
        ) +
    scale_fill_gradient2(
        name="Number of Studies",
        low="white",mid="darksalmon",high="coral3",
        midpoint=max(ctry_sum_coral1$n)/2,limits=c(0,max(ctry_sum_coral1$n))) )
    # labs(title="Study countries - Coral")  # if axes: x="X axis label", y="Y axis label"
ggsave(paste0(plotdir,today.date,'_study_country_coral_map.png'),width = 10,height = 5)
```

# Treemapping

Outcome and Intervention tree maps

```{r eval=T}

#---- Treemapping ----
# - Outcomes
unique(data_all$Outcome.subcategory)

outcomes2 <-data_all %>% 
  filter(!is.na(Outcome.subcategory)) %>% 
  select(aid,Outcome_cat,Outcome.subcategory) %>% 
  group_by(Outcome_cat) %>% 
  mutate(out.cat=paste0(Outcome_cat,"\n (",n_distinct(aid),")")) %>% 
  group_by(Outcome_cat,Outcome.subcategory) %>% 
  mutate(n=n_distinct(aid)) %>% 
  arrange(Outcome.subcategory)
unique(outcomes2$out.cat)

pdf(file=paste0(plotdir,today.date,"_outcomes_treemap.pdf"))
treemap(outcomes2,index=c("out.cat","Outcome.subcategory"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="Study Outcomes")
dev.off()

# - Interventions
unique(data_all$Intervention.subcategory)

intervention2 <-data_all %>% 
  filter(!is.na(Intervention.subcategory)) %>% 
  select(aid,Int_cat,Intervention.subcategory) %>% 
  group_by(Int_cat) %>% 
  mutate(int.cat=paste0(Int_cat,"\n (",n_distinct(aid),")")) %>% 
  group_by(Int_cat,Intervention.subcategory) %>% 
  mutate(n=n_distinct(aid)) %>% 
  arrange(Intervention.subcategory)

unique(intervention2$int.cat)

pdf(file=paste0(plotdir,today.date,"_intervention_treemap.pdf"))
treemap(intervention2,index=c("int.cat","Intervention.subcategory"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="Study interventions")
dev.off()

```

# Studies over time 

```{r eval=T}

#---- Studies over time ----
All_time_gps <- data_all %>%
  group_by(Year.of.publication) %>% 
  summarise(pub.per.yr= n_distinct(aid)) %>% 
  ungroup() %>% 
  arrange(Year.of.publication) %>% 
  mutate(val=cumsum(pub.per.yr),
         gp="All") %>% 
  select(Year.of.publication,gp,val) %>% 
  filter(!is.na(Year.of.publication))
tail(All_time_gps)

# growth by decade
#overall
(max(All_time_gps$val)-min(All_time_gps$val))/(max(All_time_gps$Year.of.publication)-min(All_time_gps$Year.of.publication))
#1990s
(max(All_time_gps$val[All_time_gps$Year.of.publication<2000])-max(All_time_gps$val[All_time_gps$Year.of.publication<1990]))/10
#2000-2010
(max(All_time_gps$val[All_time_gps$Year.of.publication<2010])-max(All_time_gps$val[All_time_gps$Year.of.publication<2000]))/10
#2010-latest date (? Check this)
(max(All_time_gps$val)-max(All_time_gps$val[All_time_gps$Year.of.publication<2010]))/(max(All_time_gps$Year.of.publication)-2009)

Int_time_gps <-  data_all %>%
  group_by(Year.of.publication,Int_cat) %>% 
  summarise(int_per_yr= n_distinct(aid)) %>% 
  spread(Int_cat,value = int_per_yr) %>% 
  mutate_all(funs(replace(., is.na(.), 0))) %>% 
  ungroup() %>% 
  arrange(Year.of.publication) %>% 
  mutate_at(vars(-Year.of.publication),funs(cumsum(.))) %>% 
  gather("int_typ","val",-Year.of.publication) %>% 
  bind_rows(All_time_gps %>% rename(int_typ=gp))
tail(Int_time_gps)
# non-elegant way to convert units to factor in order to reorder plot legends
order.gp <- Int_time_gps %>% group_by(int_typ) %>% summarise(order_typ=max(val)) %>% arrange(desc(order_typ)) %>% pull(int_typ)
Int_time_gps <- Int_time_gps %>%  
  mutate(int_typ = factor(int_typ, levels = order.gp)) %>% 
  rename(Intervention=int_typ)

# int.cols <- c("black","blue","orangered1","yellow4","tan1")
# names(int.cols) <- order.gp

(pInt_time_gps <- ggplot(Int_time_gps)  + 
    geom_line(aes(x = Year.of.publication, y = val, group = Intervention, colour = Intervention), size = 1.3)  +
    ylab("Cumulative frequency") +
  #  scale_x_continuous(name="Year", breaks=seq(1985,2025,5)) +
  #  scale_colour_manual(values=int.cols) +
    ggtitle('Intervention') )
   # scale_y_continuous(limits=c(0,80), breaks=seq(0,80,10), labels=c("0","","20","","40","","60","","80")))


# Outcomes

out_time_gps <-  data_all %>%
  group_by(Year.of.publication,Outcome_cat) %>% 
  summarise(out_per_yr= n_distinct(aid)) %>% 
  spread(Outcome_cat,value = out_per_yr) %>% 
  mutate_all(funs(replace(., is.na(.), 0))) %>% 
  ungroup() %>% 
  arrange(Year.of.publication) %>% 
  mutate_at(vars(-Year.of.publication),funs(cumsum(.))) %>% 
  gather("out_typ","val",-Year.of.publication) %>% 
  bind_rows(All_time_gps %>% rename(out_typ=gp))
tail(out_time_gps)
# non-elegant way to convert units to factor in order to reorder plot legends
order.gp <- out_time_gps %>% group_by(out_typ) %>% summarise(order_typ=max(val)) %>% arrange(desc(order_typ)) %>% pull(out_typ)
out_time_gps <- out_time_gps %>%  
  mutate(out_typ = factor(out_typ, levels = order.gp)) %>% 
  rename(Outcome=out_typ)

# int.cols <- c("black","blue","orangered1","yellow4","tan1")
# names(int.cols) <- order.gp

(pout_time_gps <- ggplot(out_time_gps)  + 
    geom_line(aes(x = Year.of.publication, y = val, group = Outcome, colour = Outcome), size = 1.3)  +
    ylab("Cumulative frequency") +
    #  scale_x_continuous(name="Year", breaks=seq(1985,2025,5)) +
    #  scale_colour_manual(values=int.cols) +
    ggtitle('Outcome') )
# scale_y_continuous(limits=c(0,80), breaks=seq(0,80,10), labels=c("0","","20","","40","","60","","80")))
plot_grid(pInt_time_gps,pout_time_gps)
ggsave(paste0(plotdir,today.date,'_studies_over_time.png'),width = 12,height = 4)


```
# Stats Section
This section outputs a lot of the different stats used in the paper. Right now, I am just inputting them by hand, and so definitely would be useful to print out the stats I want to copy/paste and easy access

1. Basic Percentages
```{r eval=T}

# --- Percentages --- #
# test <-  data_all %>%
#   select(aid, Int_cat, Intervention.subcategory, Outcome_cat,Outcome.subcategory)

#Total number of studies
num.studies <- length(unique(data_all$aid))

#List of data headings
head(data_all,1)
```

2. P: Geographies

#Note: 
this code is incomplete
Need to do the "search for term within a row" method here (that we used for countries above (in the map)), and do it for all of the following rows 

For Continent percentages, I literally added up the counts and re-divided (out of 183) for percentages. very tedious
Sums: Asia (48), Oceania (40), Central America and the Caribbean (36), Africa (34), and North America (32), South America (13), Europe (6) 

For country percentages, I used the ctry_sum list, and not this

Scale of study isnt actually used in the report

Geographical scale of intervention is used


```{r eval=T}

# P: Geographies (aka intervention location)

# 1st step, clean up country columns and lists
##MAKING COUNTRY COLUMNS

#### Add country list
cty <- country$Country

# Continent
data_all %>%
  group_by(Continent) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # this arranges them in descending order 

# Country
data_all %>%
  group_by(study.ctry) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # this arranges them in descending order 
  # arrange(num)

# Scale of Study
data_all %>%
  group_by(Scale.of.study) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # this arranges them in descending order 

# Geographic Scale of Intervention
data_all %>%
  group_by(Geographic.scale.of.intervention) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # this arranges them in descending order 
##### Need to pinpoint NAs, L vs L for local

```

3. P: Habitats

```{r eval=T}

# Coral
data_all %>%
  filter(coral==1) %>% 
  summarise(habitat="Coral", num=n_distinct(aid), pct=num/num.studies*100)

# Seagrass
data_all %>%
  filter (seagrass==1) %>% 
  summarise(habitat="Seagrass", num=n_distinct(aid), pct=num/num.studies*100) 

# Mangrove
data_all %>%
  filter (mangrove==1) %>% 
  summarise(habitat="Mangrove", num=n_distinct(aid), pct=num/num.studies*100) 

# Note: these DO contain overlap, ie. some studies have multiple habitats:
data_all %>%
  group_by(Habitat.type) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num)) 

# How many studies took place in only one of three habitats?
data_all %>% 
  filter(coral + seagrass + mangrove == 1) %>% 
  summarise(habitat="Only One",num=n_distinct(aid), pct=num/num.studies*100)

# How many studies took place in multiple habitats? (2 or more)
  #doesn't include "other"
data_all %>% 
  filter(coral + seagrass + mangrove >= 2) %>% 
  summarise(habitat="Multiple: 2 or more!", num=n_distinct(aid), pct=num/num.studies*100)

# How many studies took place in all 3 habitats?
data_all %>% 
  filter(coral + seagrass + mangrove == 3) %>% 
  summarise(habitat="All 3 Habitats!", num=n_distinct(aid), pct=num/num.studies*100)

# What are the "other" studies that don't define a habitat?
  unique(data_all$aid[data_all$Habitat.type=="Other"])
  # ONLY for the habitat types that are ONLY other, aka doesn't include 
    # studies that have a "real" habitat and an "Other"

  
```

4. I: Interventions

```{r eval=T}
  
# I: Interventions
data_all %>%
  group_by(Int_cat) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # arranges them in descending order 

  # Highest: % in cons design and planning, species management
data_all %>%  
  filter(Int_cat== "2. Species management"| 
           Int_cat== "6. Conservation designation & planning") %>%  
  summarise(intervention="Highest", num=n_distinct(aid), pct=num/num.studies*100)

  # Lowest: % in Enforcement and Protection, awareness raising, and 
    # Education and Training
data_all %>%  
  filter(Int_cat== "4. Enforcement & protection"| 
           Int_cat== "3. Awareness raising"| 
           Int_cat== "9. Education & training") %>%  
  summarise(intervention="Lowest", num=n_distinct(aid), pct=num/num.studies*100)

  # Subcategories (want % of each):
data_all %>%
  group_by(Intervention.subcategory) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # arranges them in descending order 
  # arrange (num) # arranges in ascending order, swap


```

5. C: Comparators, Study designs used

IN PROGRESS

# Discuss w David: what do we want from this section/how in depth?
# Still playing around

```{r eval=T}

  # Primary vs Secondary Data
data_all %>%
  group_by(Primary.or.secondary.data.) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # this arranges them in descending order 

  # Study Design
data_all %>%
  group_by(Study.design) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # this arranges them in descending order 
##### Need to do the "search for term within a row" method here

  # Type of Data
data_all %>%
  group_by(What.type.of.data.does.this.study.consider.) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # this arranges them in descending order 
##### Need to do the "search for term within a row" method here

  # Comparator Type
data_all %>%
  group_by(Comparator.type) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # this arranges them in descending order 
  # arrange (num) # for ascending order, swap
##### Need to do the "search for term within a row" method here

  # Does the Study population considers human groups?
data_all %>%
  group_by(Does.the.study.explicitly.examine.impacts.on.different.human.groups.) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
  arrange (desc(num))  # this arranges them in descending order 

#Find and look at the ONE NA Study here... what are the notes on this?
quick.stats <- data_all %>% 
         filter(is.na(Does.the.study.explicitly.examine.impacts.on.different.human.groups.))
unique(quick.stats$aid)
    # way to filter it without looking at data/one line, no quick.stats:
    # unique(data_all %>% 
      # filter(is.na(Does.the.study.explicitly.examine.impacts.on.different.human.groups.)) %>% 
      # select(aid))
    # non-piping way to do it:
      # unique(data_all$aid[is.na(data_all$Does.the.study.explicitly.examine.impacts.on.different.human.groups)])

  # Note: This 1 NA is tech number 205, so there must be a duplicate that got in
  # One section has both an N and a Y...
###########How do I ID which one has an overlap?

  # If so, what types?
  # NOT worth analysis, most of these are NAs:
    # data_all %>%
    #  group_by(If.so..what.types.of.different.groups.) %>% 
    #  summarise(num=n_distinct(aid), pct=num/num.studies*100)  %>%
    #  arrange (desc(num))  # this arranges them in descending order 

```
# Multiple Intervention Studies

#from May 28, need to go back and figure out the rest here/what exactly is going on
```{r eval=T}
(multi.int.studies <- data_all %>% 
    #   filter(Int_cat!="8. Research & monitoring") %>% 
    group_by(Year.of.publication,aid) %>% 
    summarise(n.int=n_distinct(Int_cat))
)
multi.int.aid <- multi.int.studies$aid[multi.int.studies$n.int>1]


# spot checks
table(test$n.int)
filter(test,n.int==3)
unique(data_all$Int_cat[data_all$aid==187])
data_all %>% 
  select(aid,Int_cat) %>% 
  filter(aid==187)


Multi_int_time_gps <- data_all %>%
  filter(aid%in%multi.int.aid) %>% 
  group_by(Year.of.publication) %>% 
  summarise(pub.per.yr= n_distinct(aid)) %>% 
  ungroup() %>% 
  arrange(Year.of.publication) %>% 
  mutate(val=cumsum(pub.per.yr),
         gp="Multi-intervention") %>% 
  select(Year.of.publication,gp,pub.per.yr,val) %>% 
  filter(!is.na(Year.of.publication))
View(Multi_int_time_gps)




```

6. O: Outcomes:

```{r eval=T}

data_all %>%
  group_by(Outcome_cat) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100)

  # % Pop/Species and Ecological Community combined (no overlaps):
data_all %>%  
  filter(Outcome_cat== "1. Population/species"| 
         Outcome_cat==  "2. Ecological community") %>%  
  summarise(num=n_distinct(aid), pct=num/num.studies*100)

  # % in human well-being, knowledge and behavior, and governance
data_all %>%  
  filter(Outcome_cat== "5. Human well-being"| 
          Outcome_cat== "6. Knowledge and behavior"| 
          Outcome_cat== "7. Governance") %>%  
  summarise(num=n_distinct(aid), pct=num/num.studies*100)

  # % in ecosystem function and ecosystem service
data_all %>%  
  filter(Outcome_cat== "3. Ecosystem function"| 
          Outcome_cat==  "4. Ecosystem services") %>%  
  summarise(num=n_distinct(aid), pct=num/num.studies*100)
  
  # Subcategories (want % of each):
data_all %>% 
  group_by(Outcome.subcategory) %>% 
  summarise(num=n_distinct(aid), pct=num/num.studies*100) %>%
  arrange (desc(num))  # this arranges them in descending order 
  # arrange (num) # for ascending order, swap
  
```

# Add eco vs soc outcome counts
```{r eval=T}
unique(data_all$Outcome_cat)
eco.outcomes <- c("2. Ecological community", "1. Population/species", "3. Ecosystem function")
soc.outcomes <- c("6. Knowledge and behavior", "5. Human well-being", "7. Governance")
        
data_all <- data_all %>%
  # select(aid, Outcome_cat) %>%
  mutate(eco.out=ifelse(Outcome_cat%in%eco.outcomes,1,0),
         soc.out=ifelse(Outcome_cat%in%soc.outcomes,1,0),
         es.out=ifelse(Outcome_cat=="4. Ecosystem services",1,0)) %>% 
  group_by(aid) %>% 
  mutate(eco.aid=max(eco.out),
            soc.aid=max(soc.out),
            es.aid=max(es.out),
            eco.soc.aid=ifelse(eco.aid+soc.aid>1,1,0),
            es.eco.soc.aid=ifelse(eco.aid+es.aid>1 | soc.aid+es.aid>1,1,0),
            interdisc.aid=ifelse(eco.soc.aid==1 | es.eco.soc.aid==1,1,0)) 

View(select(data_all,Outcome_cat,eco.aid:interdisc.aid)) # spot check

# Which studies have both Ecological and Social outcomes? (No ecosystem services)
<<<<<<< HEAD
out.eco.v.soc %>% 
  filter(sum.out == 1) %>% 
  summarise(EcoSoc="Eco and Soc, no ES",num=n_distinct(aid))
=======
n_distinct(data_all$aid[data_all$eco.soc.aid == 1])
>>>>>>> 1f507f9b1e1165b0b105430e8795379db323daec

# Which studies have both Ecological and Social outcomes? (includes ecosystem services)
n_distinct(data_all$aid[data_all$interdisc.aid == 1])

# Eco_Soc_ES_Out and export csv
Eco_Soc_ES_Out <- data_all %>%
  filter(interdisc.aid == 1)
View(select(Eco_Soc_ES_Out,Outcome_cat,eco.aid:interdisc.aid)) # spot check

write.csv(Eco_Soc_ES_Out,paste0(workdir,"tables/20210331_Eco_and_Soc_and_ES_Outcomes.csv"))

```

## Interdisciplinary outcome comparison heat maps
```{r eval=T}
Eco_Soc_ES_Out <- data_all %>%
  filter(interdisc.aid == 1)

# All ecosystems all  vs interdisc. studies
my_heat_map(Eco_Soc_ES_Out,"Int_cat","Outcome_cat")
(heat.map.all.itd <- heat.map +
    labs(x="Conservation Intervention", y="Outcome", title ="All ecosystems"))
plot_grid(heat.map.all + labs(title= "all studies"),
          heat.map.all.itd + labs(title= "interdisciplinary studies"))
ggsave(paste0(plotdir,today.date,'_interdisc_int_out_map.png'),width = 16,height = 8)

# Coral
my_heat_map(filter(data_all,coral==1),"Int_cat","Outcome_cat", high.col = "coral3")
io_counts.coral <- io_counts
(heat.map.coral <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Coral"))

# Mangrove
my_heat_map(filter(data_all,mangrove==1),"Int_cat","Outcome_cat", high.col = "orange2")
io_counts.mangrove <- io_counts
(heat.map.mangrove <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Mangrove")) 

# Seagrass
my_heat_map(filter(data_all,seagrass==1),"Int_cat","Outcome_cat", high.col = "green4")
io_counts.seagrass <- io_counts
(heat.map.seagrass <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Seagrass")) 

# Ecosystem maps on same scale
max.val <- max(io_counts.mangrove$n,io_counts.coral$n,io_counts.seagrass$n)
p.ecosystem.all <- plot_grid(heat.map.coral + scale_fill_gradient2(low="#f7fbff",high= "coral3",name="# Cases",na.value="black", limits=c(0,max.val)),
          heat.map.seagrass + scale_fill_gradient2(low="#f7fbff",high= "green4",name="# Cases",na.value="black", limits=c(0,max.val)),
          heat.map.mangrove + scale_fill_gradient2(low="#f7fbff",high= "orange2",name="# Cases",na.value="black", limits=c(0,max.val)),
          labels=letters[1:3], ncol = 3, nrow = 1, hjust=-1, align = "hv")

# Coral
my_heat_map(filter(Eco_Soc_ES_Out,coral==1),"Int_cat","Outcome_cat", high.col = "coral3")
io_counts.coral.itdc <- io_counts
(heat.map.coral.itdc <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Coral"))

# Mangrove
my_heat_map(filter(Eco_Soc_ES_Out,mangrove==1),"Int_cat","Outcome_cat", high.col = "orange2")
io_counts.mangrove.itdc <- io_counts
(heat.map.mangrove.itdc <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Mangrove")) 

# Seagrass
my_heat_map(filter(Eco_Soc_ES_Out,seagrass==1),"Int_cat","Outcome_cat", high.col = "green4")
io_counts.seagrass.itdc <- io_counts
(heat.map.seagrass.itdc <- heat.map + labs(x="Conservation Intervention", y="Outcome", title ="Seagrass")) 

# Ecosystem maps on same scale
max.val <- max(io_counts.mangrove.itdc$n,io_counts.coral.itdc$n,io_counts.seagrass.itdc$n)
p.ecosystem.all.itdc <- plot_grid(heat.map.coral.itdc + scale_fill_gradient2(low="#f7fbff",high= "coral3",name="# Cases",na.value="black", limits=c(0,max.val)),
          heat.map.seagrass.itdc + scale_fill_gradient2(low="#f7fbff",high= "green4",name="# Cases",na.value="black", limits=c(0,max.val)),
          heat.map.mangrove.itdc + scale_fill_gradient2(low="#f7fbff",high= "orange2",name="# Cases",na.value="black", limits=c(0,max.val)),
          labels=letters[1:3], ncol = 3, nrow = 1, hjust=-1, align = "hv")

plot_grid(p.ecosystem.all,p.ecosystem.all.itdc,nrow=2)
ggsave(paste0(plotdir,today.date,'_interdisc_habitat_int_out_map.png'),width = 17,height = 16)
```

## Multi-intervention & Interdisciplinary outcome sub heat maps
```{r eval=T}

#  INterventions
int.x.count <- data_all %>% 
  select(aid, Int_cat) %>% 
  filter(Int_cat!="" & !is.na(Int_cat)) %>%  # just in case
  arrange(aid,Int_cat) %>% 
  distinct() %>%
  group_by(aid) %>%
  filter(n() > 1) %>%
  split(.$aid) %>%
  map(., 2) %>%
  map(~combn(.x, m = 2)) %>%
  map(~t(.x)) %>%
  map_dfr(as_tibble) %>% 
  group_by(V1,V2) %>% 
  count() %>% 
  rename(Int1=V1,Int2=V2)
  
  int.x.list <- expand.grid(int_list$int_val,int_list$int_val)  %>% 
    rename(Int1=Var1,Int2=Var2)

  int.x.count.full <- int.x.count %>% 
    full_join(int.x.list) %>%   # inserts missing combinations
  #  mutate(n=replace_na(n,0)) %>%
    ungroup() %>% 
    mutate( Int1=factor( Int1,levels=mixedsort(int_list$int_val))  # set int list in right order
 )

ggplot(data=int.x.count.full, aes(x=Int2,y=reorder(Int1, desc(Int1)))) +
    theme_bw() +
    geom_tile(aes(fill = n), color='white',size=0.1) +
    scale_fill_gradient(low = '#f7fbff', high = '#2171b5', space = 'Lab',na.value="white",limits=c(0,max(int.x.count.full$n))) +
    geom_text(aes(label=n),show.legend = T) +
    theme(axis.text.x=element_text(angle=90),
          axis.ticks=element_blank(),
          axis.line=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_line(color='#eeeeee'))+
    theme(axis.text.x = element_text(angle=45,hjust=0,vjust=1,size=9)) +
    scale_x_discrete(position = "top") +
    scale_y_discrete(position = "right") +
    labs(x="Intervention 1", y="Intervention 2")
  ggsave(paste0(plotdir,today.date,'_multiple_int_map.png'),width = 8,height = 8)
  
  
# Sub-interventions
sub.int.x.count <- data_all %>% 
    select(aid, Intervention.subcategory) %>% 
    filter(Intervention.subcategory!="" & !is.na(Intervention.subcategory)) %>%  # just in case
    arrange(aid,Intervention.subcategory) %>% 
    distinct() %>%
    group_by(aid) %>%
    filter(n() > 1) %>%
    split(.$aid) %>%
    map(., 2) %>%
    map(~combn(.x, m = 2)) %>%
    map(~t(.x)) %>%
    map_dfr(as_tibble) %>% 
    group_by(V1,V2) %>% 
    count() %>% 
    rename(Int1=V1,Int2=V2)
  
sub.int.x.list <- expand.grid(int_sub_list$int_val,int_sub_list$int_val)  %>% 
    rename(Int1=Var1,Int2=Var2)
  
sub.int.x.count.full <- sub.int.x.count %>% 
    full_join(sub.int.x.list) %>%   # inserts missing combinations
   # mutate(n=replace_na(n,0)) %>%
    ungroup() %>% 
    mutate( Int1=factor( Int1,levels=mixedsort(int_sub_list$int_val))  # set int list in right order
    )
  
ggplot(data=sub.int.x.count.full, aes(x=Int2,y=reorder(Int1, desc(Int1)),fill=n)) +
  theme_bw() +
  geom_tile(aes(fill = n), color='white',size=0.1) +
  scale_fill_gradient(low = '#f7fbff', high = '#2171b5', space = 'Lab',na.value="white",limits=c(0,max(sub.int.x.count.full$n))) +
  geom_text(aes(label=n),show.legend = T) +
  theme(axis.text.x=element_text(angle=90),
        axis.ticks=element_blank(),
        axis.line=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_line(color='#eeeeee'))+
  theme(axis.text.x = element_text(angle=45,hjust=0,vjust=1,size=9)) +
  scale_x_discrete(position = "top") +
  scale_y_discrete(position = "right") +
  labs(x="Sub-Intervention 1", y="Sub-Intervention 2")
ggsave(paste0(plotdir,today.date,'_multiple_sub_int_map.png'),width = 12,height = 12)
  
  
# Outcomes
out.x.count <- data_all %>% 
    select(aid, Outcome_cat) %>% 
    filter(Outcome_cat!="" & !is.na(Outcome_cat)) %>%  # just in case
    arrange(aid,Outcome_cat) %>% 
    distinct() %>%
    group_by(aid) %>%
    filter(n() > 1) %>%
    split(.$aid) %>%
    map(., 2) %>%
    map(~combn(.x, m = 2)) %>%
    map(~t(.x)) %>%
    map_dfr(as_tibble) %>% 
    group_by(V1,V2) %>% 
    count() %>% 
    rename(Out1=V1,Out2=V2)
  
  out.x.list <- expand.grid(out_list$out_val,out_list$out_val)  %>% 
    rename(Out1=Var1,Out2=Var2)
  
  out.x.count.full <- out.x.count %>% 
    full_join(out.x.list) %>%   # inserts missing combinations
  #  mutate(n=replace_na(n,0)) %>%
    ungroup() %>% 
    mutate(Out1=factor(Out1,levels=mixedsort(out_list$out_val))  # set Out list in right order
    )
  ggplot(data=out.x.count.full, aes(x=Out2,y=reorder(Out1, desc(Out1)),fill=n)) +
    theme_bw() +
    geom_tile(aes(fill = n), color='white',size=0.1) +
    scale_fill_gradient(low = '#f7fbff', high = '#2171b5', space = 'Lab',na.value="white",limits=c(0,max(sub.int.x.count.full$n))) +
    geom_text(aes(label=n),show.legend = T) +
    theme(axis.text.x=element_text(angle=90),
          axis.ticks=element_blank(),
          axis.line=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_line(color='#eeeeee'))+
    theme(axis.text.x = element_text(angle=45,hjust=0,vjust=1,size=9)) +
    scale_x_discrete(position = "top") +
    scale_y_discrete(position = "right") +
    labs(x="Outcome 1", y="Outcome 2")
  
ggsave(paste0(plotdir,today.date,'_multiple_out_map.png'),width = 8,height = 8)
  
  
  # sub-outcomes
sub.out.x.count <- data_all %>% 
    select(aid, Outcome.subcategory) %>% 
    filter(Outcome.subcategory!="" & !is.na(Outcome.subcategory)) %>%  # just in case
    arrange(aid,Outcome.subcategory) %>% 
    distinct() %>%
    group_by(aid) %>%
    filter(n() > 1) %>%
    split(.$aid) %>%
    map(., 2) %>%
    map(~combn(.x, m = 2)) %>%
    map(~t(.x)) %>%
    map_dfr(as_tibble) %>% 
    group_by(V1,V2) %>% 
    count() %>% 
    rename(Out1=V1,Out2=V2)
  
sub.out.x.list <- expand.grid(out_sub_list$out_val,out_sub_list$out_val)  %>% 
    rename(Out1=Var1,Out2=Var2)
  
sub.out.x.count.full <- sub.out.x.count %>% 
    full_join(sub.out.x.list) %>%   # inserts missing combinations
  #  mutate(n=replace_na(n,0)) %>%
    ungroup() %>% 
    mutate(Out1=factor(Out1,levels=mixedsort(out_sub_list$out_val))  # set Out list in right order
    )

ggplot(data=sub.out.x.count.full, aes(x=Out2,y=reorder(Out1, desc(Out1)),fill=n)) +
    theme_bw() +
    geom_tile(aes(fill = n), color='white',size=0.1) +
    scale_fill_gradient(low = '#f7fbff', high = '#2171b5', space = 'Lab',na.value="white",limits=c(0,max(sub.int.x.count.full$n))) +
    geom_text(aes(label=n),show.legend = T) +
    theme(axis.text.x=element_text(angle=90),
          axis.ticks=element_blank(),
          axis.line=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_line(color='#eeeeee'))+
    theme(axis.text.x = element_text(angle=45,hjust=0,vjust=1,size=9)) +
    scale_x_discrete(position = "top") +
    scale_y_discrete(position = "right") +
    labs(x="Outcome 1", y="Outcome 2") 
  
ggsave(paste0(plotdir,today.date,'_multiple_out_map.png'),width = 18,height = 18)
  
# Interdisciplinary sub outcomes
sub.out.x.count.intdisc <- sub.out.x.count.full %>% 
  filter(str_detect(Out1, "^[1234]") & str_detect(Out2, "^[4567]") )
unique(sub.out.x.count.intdisc$Out1)
unique(sub.out.x.count.intdisc$Out2)

ggplot(data=sub.out.x.count.intdisc, aes(x=Out1,y=reorder(Out2, desc(Out2)),fill=n)) +
    theme_bw() +
    geom_tile(aes(fill = n), color='white',size=0.1) +
    scale_fill_gradient(low = '#f7fbff', high = '#2171b5', space = 'Lab',na.value="white",limits=c(0,max(sub.int.x.count.full$n))) +
    geom_text(aes(label=n),show.legend = T) +
    theme(axis.text.x=element_text(angle=90),
          axis.ticks=element_blank(),
          axis.line=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_line(color='#eeeeee'))+
    theme(axis.text.x = element_text(angle=45,hjust=0,vjust=1,size=9)) +
    scale_x_discrete(position = "top") +
    scale_y_discrete(position = "right") +
    labs(x="Ecological + Ecosystem services", y= "Social + Ecosystem services")
  
ggsave(paste0(plotdir,today.date,'interdisc_multiple_out_map.png'),width = 11,height = 8)
  

# Multi-intervention interdiscpl-outcomes
# id multi-intervention studies
mi.aid <- data_all %>%
  group_by(aid,Int_cat) %>% 
  summarise %>% 
  group_by(aid) %>% 
  filter(n()>1) %>% 
  distinct(aid) %>% 
  pull(aid)

mi.sub.out.x.count <- data_all %>% 
  filter(aid%in%mi.aid) %>% 
    select(aid, Outcome.subcategory) %>% 
    filter(Outcome.subcategory!="" & !is.na(Outcome.subcategory)) %>%  # just in case
    arrange(aid,Outcome.subcategory) %>% 
    distinct() %>%
    group_by(aid) %>%
    filter(n() > 1) %>%
    split(.$aid) %>%
    map(., 2) %>%
    map(~combn(.x, m = 2)) %>%
    map(~t(.x)) %>%
    map_dfr(as_tibble) %>% 
    group_by(V1,V2) %>% 
    count() %>% 
    rename(Out1=V1,Out2=V2)
  
mi.sub.out.x.list <- expand.grid(out_sub_list$out_val,out_sub_list$out_val)  %>% 
    rename(Out1=Var1,Out2=Var2)
  
mi.sub.out.x.count.interdisc <- sub.out.x.count %>% 
    full_join(sub.out.x.list) %>%   # inserts missing combinations
  #  mutate(n=replace_na(n,0)) %>%
    ungroup() %>% 
    mutate(Out1=factor(Out1,levels=mixedsort(out_sub_list$out_val))  # set Out list in right order
    ) %>% 
    filter(str_detect(Out1, "^[1234]") & str_detect(Out2, "^[4567]") ) # interdisciplinary only


ggplot(data=mi.sub.out.x.count.interdisc, aes(x=Out2,y=reorder(Out1, desc(Out1)),fill=n)) +
    theme_bw() +
    geom_tile(aes(fill = n), color='white',size=0.1) +
    scale_fill_gradient(low = '#f7fbff', high = '#2171b5', space = 'Lab',na.value="white",limits=c(0,max(sub.int.x.count.full$n))) +
    geom_text(aes(label=n),show.legend = T) +
    theme(axis.text.x=element_text(angle=90),
          axis.ticks=element_blank(),
          axis.line=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_line(color='#eeeeee'))+
    theme(axis.text.x = element_text(angle=45,hjust=0,vjust=1,size=9)) +
    scale_x_discrete(position = "top") +
    scale_y_discrete(position = "right") +
    labs(x="Outcome 1", y="Outcome 2") 
  
ggsave(paste0(plotdir,today.date,'_multi-intervention_multiple_out_map.png'),width = 18,height = 18)



# Chord diagram
chordDiagram(mat)
chord.dat <- data_all %>% 
  filter(interdisc.aid==1) %>% 
  group_by(Int_cat,Outcome_cat) %>% 
  summarise(value=n_distinct(aid))

pacman::p_load(circlize)
chordDiagram(chord.dat)
circos.clear()


chordDiagram(chord.dat)
circos.clear()


# rotate labels (prob easier to reduce them)
png(paste0(plotdir,today.date,'_multi-intervention_multiple_out_map.png'), width = 1280, height = 960, units = "px") 
chordDiagram(chord.dat, annotationTrack = "grid", 
    preAllocateTracks = list(track.height = max(strwidth(unlist(dimnames(chord.dat))))))
# we go back to the first track and customize sector labels
circos.track(track.index = 1, panel.fun = function(x, y) {
    circos.text(CELL_META$xcenter, CELL_META$ylim[1], CELL_META$sector.index, 
        facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) 
dev.off()


```


7. Time periods

IN PROGRESS

```{r eval=T}

# Extra: Time Period:

  # % of studies after 2000
  # % of studies in the year:....
  # % of studies in [specific intervention area] during [specific time]
  
  # % of studies in top 2 interventions (cons desig and spec management) 
    # during [specific time]
  
  # could do ^ for outcome, could also try to get a chart that gives # of each
    # intervention and outcome for each year. Should be able to do this!


# make barplot
test.dat <- data_all %>%
            group_by(Outcome_cat) %>% 
            summarise(num=n_distinct(aid), pct=num/num.studies)
ggplot(test.dates(Outcome_cat,num)) +
  geom_bar(stat = )
